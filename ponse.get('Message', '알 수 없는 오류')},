warning: in the working copy of 'backend.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/backend.py b/backend.py[m
[1mindex 5f46dcf..85d024c 100644[m
[1m--- a/backend.py[m
[1m+++ b/backend.py[m
[36m@@ -6,9 +6,8 @@[m [mfrom psycopg2.extras import RealDictCursor[m
 from flask import Flask, request, jsonify[m
 from flask_cors import CORS[m
 from datetime import datetime, timedelta [m
[32m+[m[32mfrom decimal import Decimal, ROUND_HALF_UP[m
 import requests[m
[31m-import tempfile[m
[31m-import sqlite3[m
 import threading[m
 import time[m
 from functools import wraps[m
[36m@@ -47,6 +46,168 @@[m [mdef allowed_file(filename):[m
     return '.' in filename and \[m
            filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS[m
 [m
[32m+[m
[32m+[m[32mdef parse_user_identifier(raw_identifier):[m
[32m+[m[32m    """Î¨∏ÏûêÏó¥ ÎòêÎäî Ïà´ÏûêÏù∏ ÏÇ¨Ïö©Ïûê ÏãùÎ≥ÑÏûêÎ•º Ï†ïÍ∑úÌôî"""[m
[32m+[m[32m    if raw_identifier is None:[m
[32m+[m[32m        return {[m
[32m+[m[32m            'raw': None,[m
[32m+[m[32m            'user_id': None,[m
[32m+[m[32m            'external_uid': None[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m    raw_str = str(raw_identifier).strip()[m
[32m+[m[32m    if not raw_str:[m
[32m+[m[32m        return {[m
[32m+[m[32m            'raw': '',[m
[32m+[m[32m            'user_id': None,[m
[32m+[m[32m            'external_uid': None[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m    try:[m
[32m+[m[32m        numeric_id = int(raw_str)[m
[32m+[m[32m    except ValueError:[m
[32m+[m[32m        numeric_id = None[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        'raw': raw_str,[m
[32m+[m[32m        'user_id': numeric_id,[m
[32m+[m[32m        'external_uid': raw_str[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m
[32m+[m[32mdef generate_placeholder_email(external_uid: str | None, attempt: int = 0) -> str:[m
[32m+[m[32m    """Ïô∏Î∂Ä UIDÎ•º Í∏∞Î∞òÏúºÎ°ú ÏûÑÏãú Ïù¥Î©îÏùº ÏÉùÏÑ±"""[m
[32m+[m[32m    base_source = external_uid or 'user'[m
[32m+[m[32m    base = re.sub(r'[^a-zA-Z0-9]+', '_', base_source).strip('_')[m
[32m+[m[32m    if not base:[m
[32m+[m[32m        base = 'user'[m
[32m+[m[32m    suffix = f"_{attempt}" if attempt else ""[m
[32m+[m[32m    return f"{base[:180]}{suffix}@placeholder.local"[m
[32m+[m
[32m+[m
[32m+[m[32mUSER_SELECT_COLUMNS = ([m
[32m+[m[32m    "user_id, external_uid, email, username, referral_code, referral_status, "[m
[32m+[m[32m    "is_admin, created_at, updated_at"[m
[32m+[m[32m)[m
[32m+[m
[32m+[m
[32m+[m[32mdef fetch_user_record(cursor, identifier: dict, email: str | None = None):[m
[32m+[m[32m    """ÏãùÎ≥ÑÏûêÎÇò Ïù¥Î©îÏùºÎ°ú ÏÇ¨Ïö©Ïûê Î†àÏΩîÎìú Ï°∞Ìöå"""[m
[32m+[m[32m    if identifier.get('user_id') is not None:[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            f"SELECT {USER_SELECT_COLUMNS} FROM users WHERE user_id = %s",[m
[32m+[m[32m            (identifier['user_id'],)[m
[32m+[m[32m        )[m
[32m+[m[32m        row = cursor.fetchone()[m
[32m+[m[32m        if row:[m
[32m+[m[32m            return row[m
[32m+[m
[32m+[m[32m    external_uid = identifier.get('external_uid')[m
[32m+[m[32m    if external_uid:[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            f"SELECT {USER_SELECT_COLUMNS} FROM users WHERE external_uid = %s",[m
[32m+[m[32m            (external_uid,)[m
[32m+[m[32m        )[m
[32m+[m[32m        row = cursor.fetchone()[m
[32m+[m[32m        if row:[m
[32m+[m[32m            return row[m
[32m+[m
[32m+[m[32m    if email:[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            f"SELECT {USER_SELECT_COLUMNS} FROM users WHERE email = %s",[m
[32m+[m[32m            (email,)[m
[32m+[m[32m        )[m
[32m+[m[32m        row = cursor.fetchone()[m
[32m+[m[32m        if row:[m
[32m+[m[32m            return row[m
[32m+[m
[32m+[m[32m    return None[m
[32m+[m
[32m+[m
[32m+[m[32mdef ensure_user_record(cursor, identifier: dict, email: str | None = None, username: str | None = None):[m
[32m+[m[32m    """ÏÇ¨Ïö©Ïûê Î†àÏΩîÎìúÎ•º Î≥¥Ïû• (ÏóÜÏúºÎ©¥ ÏÉùÏÑ±)"""[m
[32m+[m[32m    user = fetch_user_record(cursor, identifier, email=email)[m
[32m+[m[32m    if user:[m
[32m+[m[32m        return user[m
[32m+[m
[32m+[m[32m    external_uid = identifier.get('external_uid')[m
[32m+[m[32m    if not external_uid and not email:[m
[32m+[m[32m        raise ValueError("ÏÇ¨Ïö©Ïûê ÏãùÎ≥ÑÏûê Ï†ïÎ≥¥Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.")[m
[32m+[m
[32m+[m[32m    attempt = 0[m
[32m+[m[32m    candidate_email = email or generate_placeholder_email(external_uid, attempt)[m
[32m+[m
[32m+[m[32m    while True:[m
[32m+[m[32m        cursor.execute("SELECT 1 FROM users WHERE email = %s", (candidate_email,))[m
[32m+[m[32m        if cursor.fetchone():[m
[32m+[m[32m            attempt += 1[m
[32m+[m[32m            candidate_email = generate_placeholder_email(external_uid, attempt)[m
[32m+[m[32m            continue[m
[32m+[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            f"""[m
[32m+[m[32m            INSERT INTO users (external_uid, email, username, created_at, updated_at)[m
[32m+[m[32m            VALUES (%s, %s, %s, NOW(), NOW())[m
[32m+[m[32m            RETURNING {USER_SELECT_COLUMNS}[m
[32m+[m[32m            """,[m
[32m+[m[32m            ([m
[32m+[m[32m                external_uid,[m
[32m+[m[32m                candidate_email,[m
[32m+[m[32m                username or (external_uid[:50] if external_uid else 'User')[m
[32m+[m[32m            )[m
[32m+[m[32m        )[m
[32m+[m[32m        user = cursor.fetchone()[m
[32m+[m[32m        return user[m
[32m+[m
[32m+[m
[32m+[m[32mdef ensure_wallet_record(cursor, user_id: int):[m
[32m+[m[32m    """ÏßÄÍ∞ë Î†àÏΩîÎìúÎ•º Î≥¥Ïû• (ÏóÜÏúºÎ©¥ ÏÉùÏÑ±)"""[m
[32m+[m[32m    cursor.execute([m
[32m+[m[32m        """[m
[32m+[m[32m        INSERT INTO wallets (user_id, balance, created_at, updated_at)[m
[32m+[m[32m        VALUES (%s, 0, NOW(), NOW())[m
[32m+[m[32m        ON CONFLICT (user_id) DO NOTHING[m
[32m+[m[32m        """,[m
[32m+[m[32m        (user_id,)[m
[32m+[m[32m    )[m
[32m+[m
[32m+[m[32m    cursor.execute([m
[32m+[m[32m        """[m
[32m+[m[32m        SELECT wallet_id, user_id, balance, created_at, updated_at[m
[32m+[m[32m        FROM wallets[m
[32m+[m[32m        WHERE user_id = %s[m
[32m+[m[32m        """,[m
[32m+[m[32m        (user_id,)[m
[32m+[m[32m    )[m
[32m+[m[32m    return cursor.fetchone()[m
[32m+[m
[32m+[m
[32m+[m[32mdef to_decimal(amount) -> Decimal:[m
[32m+[m[32m    """Ïà´Ïûê Í∞íÏùÑ Decimal(ÏÜåÏàòÏ†ê ÎëòÏß∏ ÏûêÎ¶¨)Î°ú Î≥ÄÌôò"""[m
[32m+[m[32m    decimal_value = Decimal(str(amount))[m
[32m+[m[32m    return decimal_value.quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)[m
[32m+[m
[32m+[m
[32m+[m[32mdef decimal_to_float(value) -> float:[m
[32m+[m[32m    """Decimal Í∞íÏùÑ floatÎ°ú Î≥ÄÌôò"""[m
[32m+[m[32m    if value is None:[m
[32m+[m[32m        return 0.0[m
[32m+[m[32m    if isinstance(value, Decimal):[m
[32m+[m[32m        return float(value)[m
[32m+[m[32m    return float(value)[m
[32m+[m
[32m+[m
[32m+[m[32mdef to_isoformat_or_none(value):[m
[32m+[m[32m    """datetime Í∞íÏùÑ ISO Ìè¨Îß∑ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò"""[m
[32m+[m[32m    if value is None:[m
[32m+[m[32m        return None[m
[32m+[m[32m    if hasattr(value, "isoformat"):[m
[32m+[m[32m        return value.isoformat()[m
[32m+[m[32m    if isinstance(value, datetime):[m
[32m+[m[32m        return value.isoformat()[m
[32m+[m[32m    return str(value)[m
[32m+[m
 # Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Îç∞ÏΩîÎ†àÏù¥ÌÑ∞[m
 def require_admin_auth(f):[m
     """Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌïú ÏóîÎìúÌè¨Ïù∏Ìä∏Ïö© Îç∞ÏΩîÎ†àÏù¥ÌÑ∞"""[m
[36m@@ -597,7 +758,6 @@[m [mdef get_service_name(service_id):[m
     # Í∏∞Î≥∏ Îß§ÌïëÎßå ÏÇ¨Ïö©ÌïòÏó¨ Îπ†Î•∏ ÏùëÎãµ Î≥¥Ïû•[m
     [m
     return service_name[m
[31m-[m
 # SMM Panel ÏÑúÎπÑÏä§ Î™©Î°ù Ï°∞Ìöå Ìï®Ïàò[m
 def get_smm_panel_services():[m
     """SMM PanelÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏÑúÎπÑÏä§ Î™©Î°ù Ï°∞Ìöå"""[m
[36m@@ -1397,7 +1557,6 @@[m [mdef schedule_order_status_update(order_id, new_status, delay_minutes):[m
     thread.daemon = True[m
     thread.start()[m
     print(f"üìÖ Ï£ºÎ¨∏ {order_id}Ïùò ÏÉÅÌÉúÍ∞Ä {delay_minutes}Î∂Ñ ÌõÑÏóê '{new_status}'Î°ú Î≥ÄÍ≤ΩÎêòÎèÑÎ°ù Ïä§ÏºÄÏ§ÑÎêòÏóàÏäµÎãàÎã§.")[m
[31m-[m
 # SMM Panel API ÏÉÅÌÉú ÌôïÏù∏ Î∞è ÏûêÎèô ÏôÑÎ£å Ï≤òÎ¶¨ Ìï®Ïàò[m
 def check_and_update_order_status():[m
     """SMM Panel APIÎ•º ÌÜµÌï¥ Ï£ºÎ¨∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ≥† ÏûêÎèôÏúºÎ°ú ÏôÑÎ£å Ï≤òÎ¶¨"""[m
[36m@@ -1681,865 +1840,92 @@[m [mif os.environ.get('FLASK_ENV') != 'production':[m
     pass[m
 [m
 def get_db_connection():[m
[31m-    """Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§."""[m
[32m+[m[32m    """PostgreSQL Ïó∞Í≤∞ÏùÑ Î∞òÌôòÌï©ÎãàÎã§."""[m
     try:[m
[31m-        # ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî Î°úÍ∑∏ ÏµúÏÜåÌôî[m
[31m-        if os.environ.get('FLASK_ENV') != 'production':[m
[31m-            pass[m
[31m-        [m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            # PostgreSQL Ïó∞Í≤∞ ÏÑ§Ï†ï ÏµúÏ†ÅÌôî[m
[31m-            conn = psycopg2.connect([m
[31m-                DATABASE_URL,[m
[31m-                connect_timeout=30,[m
[31m-                keepalives_idle=600,[m
[31m-                keepalives_interval=30,[m
[31m-                keepalives_count=3[m
[31m-            )[m
[31m-            # ÏûêÎèô Ïª§Î∞ã ÎπÑÌôúÏÑ±Ìôî (Ìä∏ÎûúÏû≠ÏÖò Ï†úÏñ¥Î•º ÏúÑÌï¥)[m
[31m-            conn.autocommit = False[m
[31m-            return conn[m
[31m-        else:[m
[31m-            # SQLite fallback - ÏòÅÍµ¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í≤ΩÎ°ú ÏÇ¨Ïö©[m
[31m-            db_path = os.path.join(os.getcwd(), 'data', 'snspmt.db')[m
[31m-            os.makedirs(os.path.dirname(db_path), exist_ok=True)  # ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±[m
[31m-            conn = sqlite3.connect(db_path, timeout=30)[m
[31m-            conn.row_factory = sqlite3.Row  # ÎîïÏÖîÎÑàÎ¶¨ ÌòïÌÉúÎ°ú Í≤∞Í≥º Î∞òÌôò[m
[31m-            return conn[m
[31m-    except psycopg2.Error as e:[m
[31m-        print(f"‚ùå PostgreSQL Ïó∞Í≤∞ Ïã§Ìå®: {e}")[m
[32m+[m[32m        conn = psycopg2.connect([m
[32m+[m[32m            DATABASE_URL,[m
[32m+[m[32m            connect_timeout=30,[m
[32m+[m[32m            keepalives_idle=600,[m
[32m+[m[32m            keepalives_interval=30,[m
[32m+[m[32m            keepalives_count=3,[m
[32m+[m[32m        )[m
[32m+[m[32m        conn.autocommit = False[m
[32m+[m[32m        return conn[m
[32m+[m[32m    except psycopg2.Error as exc:[m
[32m+[m[32m        print(f"‚ùå PostgreSQL Ïó∞Í≤∞ Ïã§Ìå®: {exc}")[m
         raise[m
[31m-    except Exception as e:[m
[31m-        raise e[m
[32m+[m
 [m
 def init_database():[m
[31m-    """Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÖåÏù¥Î∏îÏùÑ Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§."""[m
[32m+[m[32m    """Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë Ïãú ÌïÑÏàò ÌÖåÏù¥Î∏î Ï°¥Ïû¨ Ïó¨Î∂ÄÎ•º ÌôïÏù∏Ìï©ÎãàÎã§."""[m
     conn = None[m
[32m+[m[32m    cursor = None[m
[32m+[m[32m    required_tables = {[m
[32m+[m[32m        "merchants",[m
[32m+[m[32m        "users",[m
[32m+[m[32m        "categories",[m
[32m+[m[32m        "products",[m
[32m+[m[32m        "product_variants",[m
[32m+[m[32m        "packages",[m
[32m+[m[32m        "package_items",[m
[32m+[m[32m        "coupons",[m
[32m+[m[32m        "user_coupons",[m
[32m+[m[32m        "orders",[m
[32m+[m[32m        "order_items",[m
[32m+[m[32m        "referrals",[m
[32m+[m[32m        "commissions",[m
[32m+[m[32m        "wallets",[m
[32m+[m[32m        "wallet_transactions",[m
[32m+[m[32m        "payout_requests",[m
[32m+[m[32m        "payouts",[m
[32m+[m[32m        "payout_commissions",[m
[32m+[m[32m        "work_jobs",[m
[32m+[m[32m        "user_sessions",[m
[32m+[m[32m    }[m
[32m+[m
     try:[m
         conn = get_db_connection()[m
         cursor = conn.cursor()[m
[31m-        [m
[31m-        # PostgreSQLÏù∏ÏßÄ SQLiteÏù∏ÏßÄ ÌôïÏù∏[m
[31m-        is_postgresql = DATABASE_URL.startswith('postgresql://')[m
[31m-        [m
[31m-        # Ìä∏ÎûúÏû≠ÏÖò Ï§ëÎã® Ïãú Î≥µÍµ¨Î•º ÏúÑÌïú Ìó¨Ìçº Ìï®Ïàò[m
[31m-        def safe_execute(sql, params=None, commit_after=False):[m
[31m-            """ÏïàÏ†ÑÌïòÍ≤å SQL Ïã§Ìñâ (Ïò§Î•ò Î∞úÏÉù Ïãú Î°§Î∞± ÌõÑ Ïû¨ÏãúÎèÑ)"""[m
[31m-            try:[m
[31m-                if params:[m
[31m-                    cursor.execute(sql, params)[m
[31m-                else:[m
[31m-                    cursor.execute(sql)[m
[31m-                if commit_after:[m
[31m-                    conn.commit()[m
[31m-                return True[m
[31m-            except Exception as e:[m
[31m-                error_str = str(e).lower()[m
[31m-                # Ìä∏ÎûúÏû≠ÏÖò Ï§ëÎã® Ïò§Î•òÏù∏ Í≤ΩÏö∞ Î°§Î∞± ÌõÑ Ïû¨ÏãúÎèÑ[m
[31m-                if 'current transaction is aborted' in error_str or 'aborted' in error_str:[m
[31m-                    try:[m
[31m-                        conn.rollback()[m
[31m-                        # Î°§Î∞± ÌõÑ Ïû¨ÏãúÎèÑ[m
[31m-                        if params:[m
[31m-                            cursor.execute(sql, params)[m
[31m-                        else:[m
[31m-                            cursor.execute(sql)[m
[31m-                        if commit_after:[m
[31m-                            conn.commit()[m
[31m-                        return True[m
[31m-                    except Exception as retry_error:[m
[31m-                        print(f"‚ö†Ô∏è Ïû¨ÏãúÎèÑ Ïã§Ìå® (Î¨¥Ïãú): {retry_error}")[m
[31m-                        return False[m
[31m-                else:[m
[31m-                    # Îã§Î•∏ Ïò§Î•òÎäî Î¨¥Ïãú (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞ Îì±)[m
[31m-                    return False[m
[31m-        [m
[31m-        if is_postgresql:[m
[31m-            # PostgreSQL ÌÖåÏù¥Î∏î ÏÉùÏÑ±[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS users ([m
[31m-                    user_id VARCHAR(255) PRIMARY KEY,[m
[31m-                    email VARCHAR(255) UNIQUE NOT NULL,[m
[31m-                    name VARCHAR(255) NOT NULL,[m
[31m-                    display_name VARCHAR(255),[m
[31m-                    google_id VARCHAR(255),[m
[31m-                    kakao_id VARCHAR(255),[m
[31m-                    profile_image TEXT,[m
[31m-                    last_login TIMESTAMP,[m
[31m-                    last_activity TIMESTAMP DEFAULT NOW(),[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Í∏∞Ï°¥ ÌÖåÏù¥Î∏îÏóê Ïª¨Îüº Ï∂îÍ∞Ä (PostgreSQL) - Í∞Å Ïª¨ÎüºÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÏãúÎèÑ[m
[31m-            # CREATE TABLE IF NOT EXISTSÎ°ú ÌÖåÏù¥Î∏îÏù¥ ÏÉàÎ°ú ÏÉùÏÑ±ÎêòÎ©¥ Ïª¨ÎüºÏù¥ Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎØÄÎ°ú Î¨¥ÏãúÎê®[m
[31m-            def safe_add_column(column_name, column_type):[m
[31m-                """Ïª¨ÎüºÏù¥ ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ Î¨¥Ïãú)"""[m
[31m-                try:[m
[31m-                    cursor.execute("""[m
[31m-                        SELECT EXISTS ([m
[31m-                            SELECT 1 [m
[31m-                            FROM information_schema.columns [m
[31m-                            WHERE table_name = 'users' [m
[31m-                            AND column_name = %s[m
[31m-                        )[m
[31m-                    """, (column_name,))[m
[31m-                    exists = cursor.fetchone()[0][m
[31m-                    if not exists:[m
[31m-                        cursor.execute(f"ALTER TABLE users ADD COLUMN {column_name} {column_type}")[m
[31m-                        return True[m
[31m-                except Exception as e:[m
[31m-                    # Ïª¨Îüº Ï∂îÍ∞Ä Ïã§Ìå® (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÍ±∞ÎÇò Îã§Î•∏ Ïò§Î•ò) - Î¨¥Ïãú[m
[31m-                    pass[m
[31m-                return False[m
[31m-            [m
[31m-            added_cols = [][m
[31m-            if safe_add_column('google_id', 'VARCHAR(255)'):[m
[31m-                added_cols.append('google_id')[m
[31m-            if safe_add_column('kakao_id', 'VARCHAR(255)'):[m
[31m-                added_cols.append('kakao_id')[m
[31m-            if safe_add_column('profile_image', 'TEXT'):[m
[31m-                added_cols.append('profile_image')[m
[31m-            if safe_add_column('last_login', 'TIMESTAMP'):[m
[31m-                added_cols.append('last_login')[m
[31m-            if added_cols:[m
[31m-                print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Ïª¨Îüº Ï∂îÍ∞Ä ÏôÑÎ£å (PostgreSQL): {', '.join(added_cols)}")[m
[31m-            else:[m
[31m-                print("‚úÖ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Ïª¨Îüº ÌôïÏù∏ ÏôÑÎ£å (Î™®Îì† Ïª¨Îüº Ï°¥Ïû¨)")[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS points ([m
[31m-                    user_id VARCHAR(255) PRIMARY KEY,[m
[31m-                    points INTEGER DEFAULT 0,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Ï∂îÏ≤úÏù∏ ÏΩîÎìú ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS referral_codes ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    code VARCHAR(50) UNIQUE NOT NULL,[m
[31m-                    user_id VARCHAR(255),[m
[31m-                    user_email VARCHAR(255) UNIQUE,[m
[31m-                    name VARCHAR(255),[m
[31m-                    phone VARCHAR(255),[m
[31m-                    is_active BOOLEAN DEFAULT true,[m
[31m-                    usage_count INTEGER DEFAULT 0,[m
[31m-                    total_commission DECIMAL(10,2) DEFAULT 0,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Î™®Îì† Í∏∞Ï°¥ ÏΩîÎìúÎ•º Í∞ïÏ†úÎ°ú ÌôúÏÑ±Ìôî (ÌôúÏÑ±Ìôî ÏóÜÏù¥ Î∞îÎ°ú ÏÇ¨Ïö©)[m
[31m-            cursor.execute("UPDATE referral_codes SET is_active = true")[m
[31m-            print("üîÑ Î™®Îì† Ï∂îÏ≤úÏù∏ ÏΩîÎìú ÏûêÎèô ÌôúÏÑ±Ìôî ÏôÑÎ£å")[m
[31m-            [m
[31m-            # Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Í∞ïÏ†ú ÌôúÏÑ±Ìôî (Îç∞Ïù¥ÌÑ∞ ÏÜêÏã§ ÏóÜÏùå)[m
[31m-            cursor.execute("UPDATE referral_codes SET is_active = true WHERE is_active = false")[m
[31m-            updated_count = cursor.rowcount[m
[31m-            print(f"üîÑ Í∏∞Ï°¥ Ï∂îÏ≤úÏù∏ ÏΩîÎìú Í∞ïÏ†ú ÌôúÏÑ±Ìôî ÏôÑÎ£å: {updated_count}Í∞ú ÏóÖÎç∞Ïù¥Ìä∏")[m
[31m-            [m
[31m-            # Í∏∞Ï°¥ Ï∂îÏ≤úÏù∏ ÏΩîÎìúÏùò user_idÎ•º Í≥†Ïú†ÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏[m
[31m-            cursor.execute("SELECT id, user_email FROM referral_codes WHERE user_id IS NULL OR user_id = ''")[m
[31m-            existing_codes = cursor.fetchall()[m
[31m-            [m
[31m-            for code_id, user_email in existing_codes:[m
[31m-                if user_email:[m
[31m-                    import hashlib[m
[31m-                    user_unique_id = hashlib.md5(user_email.encode()).hexdigest()[:8].upper()[m
[31m-                    cursor.execute("UPDATE referral_codes SET user_id = %s WHERE id = %s", (user_unique_id, code_id))[m
[31m-                    print(f"üîÑ Ï∂îÏ≤úÏù∏ ÏΩîÎìú user_id ÏóÖÎç∞Ïù¥Ìä∏: {user_email} -> {user_unique_id}")[m
[31m-            [m
[31m-            if existing_codes:[m
[31m-                print(f"üîÑ Ï¥ù {len(existing_codes)}Í∞ú Ï∂îÏ≤úÏù∏ ÏΩîÎìú user_id ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å")[m
[31m-            [m
[31m-            # Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥ ÌôïÏù∏[m
[31m-            cursor.execute("SELECT COUNT(*) FROM referral_codes")[m
[31m-            total_count = cursor.fetchone()[0][m
[31m-            print(f"üìä Ï¥ù Ï∂îÏ≤úÏù∏ ÏΩîÎìú Ïàò: {total_count}Í∞ú (Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥Îê®)")[m
[31m-            [m
[31m-            # Ï∂îÏ≤úÏù∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS referrals ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    referrer_email VARCHAR(255) NOT NULL,[m
[31m-                    referral_code VARCHAR(50) NOT NULL,[m
[31m-                    name VARCHAR(255),[m
[31m-                    phone VARCHAR(255),[m
[31m-                    status VARCHAR(50) DEFAULT 'active',[m
[31m-                    created_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Ïª§ÎØ∏ÏÖò ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS commissions ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    referred_user VARCHAR(255) NOT NULL,[m
[31m-                    referrer_id VARCHAR(255) NOT NULL,[m
[31m-                    purchase_amount DECIMAL(10,2) NOT NULL,[m
[31m-                    commission_amount DECIMAL(10,2) NOT NULL,[m
[31m-                    commission_rate DECIMAL(5,4) NOT NULL,[m
[31m-                    is_paid BOOLEAN DEFAULT false,[m
[31m-                    payment_date TIMESTAMP DEFAULT NOW(),[m
[31m-                    paid_date TIMESTAMP,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Ïø†Ìè∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS coupons ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    user_id VARCHAR(255) NOT NULL,[m
[31m-                    referral_code VARCHAR(50),[m
[31m-                    discount_type VARCHAR(20) DEFAULT 'percentage',[m
[31m-                    discount_value DECIMAL(5,2) NOT NULL,[m
[31m-                    is_used BOOLEAN DEFAULT false,[m
[31m-                    used_at TIMESTAMP,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    expires_at TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # commission_ledger ÌÖåÏù¥Î∏î ÏÉùÏÑ± (ÌÜµÌï©: commission_points, commission_payments, commissions ÎåÄÏ≤¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS commission_ledger ([m
[31m-                    ledger_id SERIAL PRIMARY KEY,[m
[31m-                    referral_code VARCHAR(50) NOT NULL,[m
[31m-                    referrer_user_id VARCHAR(255) NOT NULL,[m
[31m-                    referred_user_id VARCHAR(255),[m
[31m-                    order_id VARCHAR(255),[m
[31m-                    event VARCHAR(50) NOT NULL CHECK (event IN ('earn','payout','adjust','reverse')),[m
[31m-                    base_amount DECIMAL(10,2),[m
[31m-                    commission_rate DECIMAL(5,4),[m
[31m-                    amount DECIMAL(10,2) NOT NULL,[m
[31m-                    status VARCHAR(50) NOT NULL DEFAULT 'confirmed' CHECK (status IN ('pending','confirmed','cancelled')),[m
[31m-                    notes TEXT,[m
[31m-                    external_ref VARCHAR(100),[m
[31m-                    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    confirmed_at TIMESTAMP,[m
[31m-                    CONSTRAINT fk_ledger_code FOREIGN KEY (referral_code) REFERENCES referral_codes(code),[m
[31m-                    CONSTRAINT fk_ledger_owner FOREIGN KEY (referrer_user_id) REFERENCES users(user_id) ON DELETE CASCADE,[m
[31m-                    CONSTRAINT fk_ledger_refer FOREIGN KEY (referred_user_id) REFERENCES users(user_id),[m
[31m-                    CONSTRAINT fk_ledger_order FOREIGN KEY (order_id) REFERENCES orders(order_id)[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ commission_ledger ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (ÌÜµÌï© ÌÖåÏù¥Î∏î)")[m
[31m-            [m
[31m-            # commission_ledger Ïù∏Îç±Ïä§ ÏÉùÏÑ±[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_code_time ON commission_ledger(referral_code, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_owner_time ON commission_ledger(referrer_user_id, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_event_time ON commission_ledger(event, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_order ON commission_ledger(order_id)")[m
[31m-            print("‚úÖ commission_ledger Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å")[m
[31m-            [m
[31m-            # orders.referral_code Ïô∏Îûò ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ Ï∂îÍ∞Ä[m
[31m-            try:[m
[31m-                cursor.execute("""[m
[31m-                    SELECT constraint_name [m
[31m-                    FROM information_schema.table_constraints [m
[31m-                    WHERE table_name='orders' AND constraint_name='fk_orders_referral_code'[m
[31m-                """)[m
[31m-                if not cursor.fetchone():[m
[31m-                    cursor.execute("""[m
[31m-                        ALTER TABLE orders [m
[31m-                        ADD CONSTRAINT fk_orders_referral_code [m
[31m-                        FOREIGN KEY (referral_code) REFERENCES referral_codes(code)[m
[31m-                    """)[m
[31m-                    print("‚úÖ orders.referral_code Ïô∏Îûò ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ Ï∂îÍ∞Ä ÏôÑÎ£å")[m
[31m-            except Exception as e:[m
[31m-                print(f"‚ö†Ô∏è orders.referral_code Ïô∏Îûò ÌÇ§ Ï∂îÍ∞Ä Ïã§Ìå® (Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï† Ïàò ÏûàÏùå): {e}")[m
[31m-            [m
[31m-            # commission_ledger Ìä∏Î¶¨Í±∞ Ìï®Ïàò ÏÉùÏÑ± (referral_codes.total_commission ÏûêÎèô ÎèôÍ∏∞Ìôî)[m
[31m-            cursor.execute("""[m
[31m-                CREATE OR REPLACE FUNCTION sync_referral_commission()[m
[31m-                RETURNS TRIGGER AS $$[m
[31m-                BEGIN[m
[31m-                  UPDATE referral_codes[m
[31m-                     SET total_commission = ([m
[31m-                       SELECT COALESCE(SUM(amount), 0)[m
[31m-                       FROM commission_ledger[m
[31m-                       WHERE referral_code = COALESCE(NEW.referral_code, OLD.referral_code)[m
[31m-                         AND status='confirmed'[m
[31m-                     )[m
[31m-                   WHERE code = COALESCE(NEW.referral_code, OLD.referral_code);[m
[31m-                  [m
[31m-                  RETURN COALESCE(NEW, OLD);[m
[31m-                END;[m
[31m-                $$ LANGUAGE plpgsql;[m
[31m-            """)[m
[31m-            [m
[31m-            # commission_ledger Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±[m
[31m-            cursor.execute("DROP TRIGGER IF EXISTS trg_commission_ai ON commission_ledger")[m
[31m-            cursor.execute("""[m
[31m-                CREATE TRIGGER trg_commission_ai AFTER INSERT ON commission_ledger[m
[31m-                FOR EACH ROW EXECUTE FUNCTION sync_referral_commission()[m
[31m-            """)[m
[31m-            cursor.execute("DROP TRIGGER IF EXISTS trg_commission_au ON commission_ledger")[m
[31m-            cursor.execute("""[m
[31m-                CREATE TRIGGER trg_commission_au AFTER UPDATE ON commission_ledger[m
[31m-                FOR EACH ROW EXECUTE FUNCTION sync_referral_commission()[m
[31m-            """)[m
[31m-            cursor.execute("DROP TRIGGER IF EXISTS trg_commission_ad ON commission_ledger")[m
[31m-            cursor.execute("""[m
[31m-                CREATE TRIGGER trg_commission_ad AFTER DELETE ON commission_ledger[m
[31m-                FOR EACH ROW EXECUTE FUNCTION sync_referral_commission()[m
[31m-            """)[m
[31m-            print("‚úÖ commission_ledger Ìä∏Î¶¨Í±∞ ÏÉùÏÑ± ÏôÑÎ£å (referral_codes.total_commission ÏûêÎèô ÎèôÍ∏∞Ìôî)")[m
[31m-            [m
[31m-            # Í≥µÏßÄÏÇ¨Ìï≠ ÌÖåÏù¥Î∏î ÏÉùÏÑ±[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS notices ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    title VARCHAR(255) NOT NULL,[m
[31m-                    content TEXT NOT NULL,[m
[31m-                    image_url VARCHAR(500),[m
[31m-                    is_active BOOLEAN DEFAULT true,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Î∏îÎ°úÍ∑∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ±[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS blog_posts ([m
[31m-                    id SERIAL PRIMARY KEY,[m
[31m-                    title VARCHAR(255) NOT NULL,[m
[31m-                    content TEXT NOT NULL,[m
[31m-                    excerpt TEXT,[m
[31m-                    category VARCHAR(100),[m
[31m-                    thumbnail_url TEXT,[m
[31m-                    tags JSONB DEFAULT '[]',[m
[31m-                    is_published BOOLEAN DEFAULT false,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    view_count INTEGER DEFAULT 0[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Ï£ºÎ¨∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS orders ([m
[31m-                    order_id VARCHAR(255) PRIMARY KEY,[m
[31m-                    user_id VARCHAR(255) NOT NULL,[m
[31m-                    user_email VARCHAR(255),[m
[31m-                    service_id VARCHAR(255) NOT NULL,[m
[31m-                    platform VARCHAR(255),[m
[31m-                    service_name VARCHAR(255),[m
[31m-                    service_type VARCHAR(255),[m
[31m-                    service_platform VARCHAR(255),[m
[31m-                    service_quantity INTEGER,[m
[31m-                    service_link TEXT,[m
[31m-                    link TEXT NOT NULL,[m
[31m-                    quantity INTEGER NOT NULL,[m
[31m-                    price DECIMAL(10,2) NOT NULL,[m
[31m-                    total_price DECIMAL(10,2),[m
[31m-                    amount DECIMAL(10,2),[m
[31m-                    discount_amount DECIMAL(10,2) DEFAULT 0,[m
[31m-                    referral_code VARCHAR(50),[m
[31m-                    status VARCHAR(50) DEFAULT 'pending',[m
[31m-                    external_order_id VARCHAR(255),[m
[31m-                    remarks TEXT,[m
[31m-                    comments TEXT,[m
[31m-                    is_scheduled BOOLEAN DEFAULT FALSE,[m
[31m-                    scheduled_datetime TIMESTAMP,[m
[31m-                    is_split_delivery BOOLEAN DEFAULT FALSE,[m
[31m-                    split_days INTEGER DEFAULT 0,[m
[31m-                    split_quantity INTEGER DEFAULT 0,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-        # order_id Ïª¨Îüº ÌÉÄÏûÖ ÌôïÏù∏ (Í∏∞Ï°¥ INTEGER Ïú†ÏßÄ) - PostgreSQLÎßå[m
[31m-        if is_postgresql:[m
[31m-            try:[m
[31m-                cursor.execute("""[m
[31m-                    SELECT data_type FROM information_schema.columns [m
[31m-                    WHERE table_name = 'orders' AND column_name = 'order_id'[m
[31m-                """)[m
[31m-                column_info = cursor.fetchone()[m
[31m-                if column_info:[m
[31m-                    current_type = column_info[0][m
[31m-                    print(f"üîç ÌòÑÏû¨ order_id Ïª¨Îüº ÌÉÄÏûÖ: {current_type}")[m
[31m-                    print(f"‚ÑπÔ∏è order_id Ïª¨Îüº ÌÉÄÏûÖ: {current_type} (Í∏∞Ï°¥ Î∞©Ïãù Ïú†ÏßÄ)")[m
[31m-                else:[m
[31m-                    print("‚ö†Ô∏è order_id Ïª¨Îüº Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")[m
[31m-            except Exception as e:[m
[31m-                print(f"‚ö†Ô∏è order_id Ïª¨Îüº ÌÉÄÏûÖ ÌôïÏù∏ Ïã§Ìå®: {e}")[m
[31m-                try:[m
[31m-                    conn.rollback()[m
[31m-                except:[m
[31m-                    pass[m
[31m-            [m
[31m-            # Í∏∞Ï°¥ ÌÖåÏù¥Î∏îÏóê ÏòàÏïΩ/Î∂ÑÌï† ÌïÑÎìú Ï∂îÍ∞Ä (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞ Î¨¥Ïãú)[m
[31m-            def safe_add_order_column(column_name, column_type):[m
[31m-                """Ïª¨ÎüºÏù¥ ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ Î¨¥Ïãú)"""[m
[31m-                try:[m
[31m-                    cursor.execute("""[m
[31m-                        SELECT EXISTS ([m
[31m-                            SELECT 1 [m
[31m-                            FROM information_schema.columns [m
[31m-                            WHERE table_name = 'orders' [m
[31m-                            AND column_name = %s[m
[31m-                        )[m
[31m-                    """, (column_name,))[m
[31m-                    exists = cursor.fetchone()[0][m
[31m-                    if not exists:[m
[31m-                        cursor.execute(f"ALTER TABLE orders ADD COLUMN {column_name} {column_type}")[m
[31m-                        return True[m
[31m-                except Exception as e:[m
[31m-                    # Ìä∏ÎûúÏû≠ÏÖò Ï§ëÎã® Ïò§Î•òÏù∏ Í≤ΩÏö∞ Î°§Î∞± ÌõÑ Ïû¨ÏãúÎèÑ[m
[31m-                    error_str = str(e).lower()[m
[31m-                    if 'current transaction is aborted' in error_str:[m
[31m-                        try:[m
[31m-                            conn.rollback()[m
[31m-                            # Î°§Î∞± ÌõÑ Ïª¨Îüº Ï°¥Ïû¨ Ïó¨Î∂Ä Îã§Ïãú ÌôïÏù∏[m
[31m-                            cursor.execute("""[m
[31m-                                SELECT EXISTS ([m
[31m-                                    SELECT 1 [m
[31m-                                    FROM information_schema.columns [m
[31m-                                    WHERE table_name = 'orders' [m
[31m-                                    AND column_name = %s[m
[31m-                                )[m
[31m-                            """, (column_name,))[m
[31m-                            exists = cursor.fetchone()[0][m
[31m-                            if not exists:[m
[31m-                                cursor.execute(f"ALTER TABLE orders ADD COLUMN {column_name} {column_type}")[m
[31m-                                return True[m
[31m-                        except Exception as retry_error:[m
[31m-                            pass[m
[31m-                    # Ïª¨Îüº Ï∂îÍ∞Ä Ïã§Ìå® (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÍ±∞ÎÇò Îã§Î•∏ Ïò§Î•ò) - Î¨¥Ïãú[m
[31m-                    pass[m
[31m-                return False[m
[31m-            [m
[31m-            added_order_cols = [][m
[31m-            if safe_add_order_column('is_scheduled', 'BOOLEAN DEFAULT FALSE'):[m
[31m-                added_order_cols.append('is_scheduled')[m
[31m-            if safe_add_order_column('scheduled_datetime', 'TIMESTAMP'):[m
[31m-                added_order_cols.append('scheduled_datetime')[m
[31m-            if safe_add_order_column('is_split_delivery', 'BOOLEAN DEFAULT FALSE'):[m
[31m-                added_order_cols.append('is_split_delivery')[m
[31m-            if safe_add_order_column('split_days', 'INTEGER DEFAULT 0'):[m
[31m-                added_order_cols.append('split_days')[m
[31m-            if safe_add_order_column('split_quantity', 'INTEGER DEFAULT 0'):[m
[31m-                added_order_cols.append('split_quantity')[m
[31m-            if added_order_cols:[m
[31m-                print(f"‚úÖ ÏòàÏïΩ/Î∂ÑÌï† ÌïÑÎìú Ï∂îÍ∞Ä ÏôÑÎ£å: {', '.join(added_order_cols)}")[m
[31m-            else:[m
[31m-                print("‚úÖ ÏòàÏïΩ/Î∂ÑÌï† ÌïÑÎìú ÌôïÏù∏ ÏôÑÎ£å (Î™®Îì† ÌïÑÎìú Ï°¥Ïû¨)")[m
[31m-        [m
[31m-        # execution_progress ÌÖåÏù¥Î∏î ÏÉùÏÑ± (ÌÜµÌï©: package_progress, split_delivery_progress, scheduled_orders ÎåÄÏ≤¥) - PostgreSQLÎßå[m
[31m-        if is_postgresql:[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS execution_progress ([m
[31m-                    exec_id SERIAL PRIMARY KEY,[m
[31m-                    order_id VARCHAR(255) NOT NULL,[m
[31m-                    exec_type VARCHAR(50) NOT NULL CHECK (exec_type IN ('package')),[m
[31m-                    step_number INTEGER NOT NULL,[m
[31m-                    step_name VARCHAR(255),[m
[31m-                    service_id VARCHAR(255),[m
[31m-                    quantity INTEGER,[m
[31m-                    scheduled_datetime TIMESTAMP,[m
[31m-                    priority SMALLINT NOT NULL DEFAULT 5,[m
[31m-                    lock_token VARCHAR(64),[m
[31m-                    retry_count INTEGER NOT NULL DEFAULT 0,[m
[31m-                    last_error_at TIMESTAMP,[m
[31m-                    status VARCHAR(50) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','running','completed','failed','skipped','scheduled')),[m
[31m-                    smm_panel_order_id VARCHAR(255),[m
[31m-                    error_message TEXT,[m
[31m-                    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    completed_at TIMESTAMP,[m
[31m-                    failed_at TIMESTAMP,[m
[31m-                    CONSTRAINT fk_exec_order FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,[m
[31m-                    CONSTRAINT ck_exec_qty CHECK (quantity IS NULL OR quantity >= 0),[m
[31m-                    CONSTRAINT uq_exec UNIQUE (order_id, exec_type, step_number)[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ execution_progress ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (ÌÜµÌï© ÌÖåÏù¥Î∏î)")[m
[31m-            [m
[31m-            # execution_progress Ïù∏Îç±Ïä§ ÏÉùÏÑ±[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_exec_key ON execution_progress(order_id, exec_type, step_number)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_exec_status_time ON execution_progress(status, scheduled_datetime)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_exec_status_time_prio ON execution_progress(status, scheduled_datetime, priority)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_exec_lock ON execution_progress(lock_token)")[m
[31m-            print("‚úÖ execution_progress Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å")[m
[31m-            [m
[31m-            # orders ÌÖåÏù¥Î∏îÏóê ÌïÑÏöîÌïú Ïª¨ÎüºÎì§ Ï∂îÍ∞Ä (Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ ÌõÑ)[m
[31m-            def safe_add_order_col(column_name, column_type, col_type_desc=''):[m
[31m-                """Ïª¨ÎüºÏù¥ ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä (Ìä∏ÎûúÏû≠ÏÖò Ïò§Î•ò Ï≤òÎ¶¨ Ìè¨Ìï®)"""[m
[31m-                try:[m
[31m-                    cursor.execute("""[m
[31m-                        SELECT column_name [m
[31m-                        FROM information_schema.columns [m
[31m-                        WHERE table_name='orders' AND column_name=%s[m
[31m-                    """, (column_name,))[m
[31m-                    if not cursor.fetchone():[m
[31m-                        cursor.execute(f"ALTER TABLE orders ADD COLUMN {column_name} {column_type}")[m
[31m-                        conn.commit()[m
[31m-                        print(f"‚úÖ {column_name} ÌïÑÎìú Ï∂îÍ∞Ä ÏôÑÎ£å")[m
[31m-                        return True[m
[31m-                    else:[m
[31m-                        print(f"‚ÑπÔ∏è {column_name} ÌïÑÎìú Ïù¥ÎØ∏ Ï°¥Ïû¨")[m
[31m-                        return False[m
[31m-                except Exception as e:[m
[31m-                    error_str = str(e).lower()[m
[31m-                    if 'current transaction is aborted' in error_str:[m
[31m-                        try:[m
[31m-                            conn.rollback()[m
[31m-                            # Î°§Î∞± ÌõÑ Îã§Ïãú ÌôïÏù∏[m
[31m-                            cursor.execute("""[m
[31m-                                SELECT column_name [m
[31m-                                FROM information_schema.columns [m
[31m-                                WHERE table_name='orders' AND column_name=%s[m
[31m-                            """, (column_name,))[m
[31m-                            if not cursor.fetchone():[m
[31m-                                cursor.execute(f"ALTER TABLE orders ADD COLUMN {column_name} {column_type}")[m
[31m-                                conn.commit()[m
[31m-                                print(f"‚úÖ {column_name} ÌïÑÎìú Ï∂îÍ∞Ä ÏôÑÎ£å (Ïû¨ÏãúÎèÑ)")[m
[31m-                                return True[m
[31m-                            else:[m
[31m-                                print(f"‚ÑπÔ∏è {column_name} ÌïÑÎìú Ïù¥ÎØ∏ Ï°¥Ïû¨")[m
[31m-                                return False[m
[31m-                        except Exception as retry_error:[m
[31m-                            print(f"‚ö†Ô∏è {column_name} ÌïÑÎìú Ï∂îÍ∞Ä Ïã§Ìå® (Ïû¨ÏãúÎèÑ Ïã§Ìå®): {retry_error}")[m
[31m-                            try:[m
[31m-                                conn.rollback()[m
[31m-                            except:[m
[31m-                                pass[m
[31m-                            return False[m
[31m-                    else:[m
[31m-                        print(f"‚ö†Ô∏è {column_name} ÌïÑÎìú Ï∂îÍ∞Ä Ïã§Ìå®: {e}")[m
[31m-                        try:[m
[31m-                            conn.rollback()[m
[31m-                        except:[m
[31m-                            pass[m
[31m-                        return False[m
[31m-            [m
[31m-            safe_add_order_col('smm_panel_order_id', 'VARCHAR(255)')[m
[31m-            safe_add_order_col('last_status_check', 'TIMESTAMP')[m
[31m-            safe_add_order_col('detailed_service', 'TEXT')[m
[31m-            safe_add_order_col('package_steps', 'JSONB')[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS point_purchases ([m
[31m-                id SERIAL PRIMARY KEY,[m
[31m-                    purchase_id VARCHAR(255) UNIQUE,[m
[31m-                    user_id VARCHAR(255) NOT NULL,[m
[31m-                    user_email VARCHAR(255),[m
[31m-                    amount INTEGER NOT NULL,[m
[31m-                    price DECIMAL(10,2) NOT NULL,[m
[31m-                    status VARCHAR(50) DEFAULT 'pending',[m
[31m-                    depositor_name VARCHAR(255),[m
[31m-                    buyer_name VARCHAR(255),[m
[31m-                    bank_name VARCHAR(255),[m
[31m-                    bank_info TEXT,[m
[31m-                    receipt_type VARCHAR(50),[m
[31m-                    business_info TEXT,[m
[31m-                    created_at TIMESTAMP DEFAULT NOW(),[m
[31m-                    updated_at TIMESTAMP DEFAULT NOW()[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-        # PostgreSQL Î∏åÎûúÏπò ÎÅù[m
[31m-        [m
[31m-        if not is_postgresql:[m
[31m-            # SQLite ÌÖåÏù¥Î∏î ÏÉùÏÑ±[m
[31m-            cursor.execute("""[m
[31m-            CREATE TABLE IF NOT EXISTS users ([m
[31m-                    user_id TEXT PRIMARY KEY,[m
[31m-                    email TEXT UNIQUE NOT NULL,[m
[31m-                    name TEXT NOT NULL,[m
[31m-                    display_name TEXT,[m
[31m-                    google_id TEXT,[m
[31m-                    kakao_id TEXT,[m
[31m-                    profile_image TEXT,[m
[31m-                    last_login TIMESTAMP,[m
[31m-                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            # Í∏∞Ï°¥ ÌÖåÏù¥Î∏îÏóê Ïª¨Îüº Ï∂îÍ∞Ä (SQLite) - Í∞Å Ïª¨ÎüºÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÏãúÎèÑ[m
[31m-            def safe_add_sqlite_column(column_name, column_type):[m
[31m-                """Ïª¨ÎüºÏù¥ ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ Î¨¥Ïãú)"""[m
[31m-                try:[m
[31m-                    # SQLiteÎäî information_schema ÎåÄÏã† PRAGMA table_info ÏÇ¨Ïö©[m
[31m-                    cursor.execute("PRAGMA table_info(users)")[m
[31m-                    columns = [row[1] for row in cursor.fetchall()][m
[31m-                    if column_name not in columns:[m
[31m-                        cursor.execute(f"ALTER TABLE users ADD COLUMN {column_name} {column_type}")[m
[31m-                        return True[m
[31m-                except Exception as e:[m
[31m-                    # Ïª¨Îüº Ï∂îÍ∞Ä Ïã§Ìå® (Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÍ±∞ÎÇò Îã§Î•∏ Ïò§Î•ò) - Î¨¥Ïãú[m
[31m-                    pass[m
[31m-                return False[m
[31m-            [m
[31m-            added_sqlite_cols = [][m
[31m-            if safe_add_sqlite_column('google_id', 'TEXT'):[m
[31m-                added_sqlite_cols.append('google_id')[m
[31m-            if safe_add_sqlite_column('kakao_id', 'TEXT'):[m
[31m-                added_sqlite_cols.append('kakao_id')[m
[31m-            if safe_add_sqlite_column('profile_image', 'TEXT'):[m
[31m-                added_sqlite_cols.append('profile_image')[m
[31m-            if safe_add_sqlite_column('last_login', 'TIMESTAMP'):[m
[31m-                added_sqlite_cols.append('last_login')[m
[31m-            if safe_add_sqlite_column('display_name', 'TEXT'):[m
[31m-                added_sqlite_cols.append('display_name')[m
[31m-            if added_sqlite_cols:[m
[31m-                print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Ïª¨Îüº Ï∂îÍ∞Ä ÏôÑÎ£å (SQLite): {', '.join(added_sqlite_cols)}")[m
[31m-            else:[m
[31m-                print("‚úÖ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Ïª¨Îüº ÌôïÏù∏ ÏôÑÎ£å (Î™®Îì† Ïª¨Îüº Ï°¥Ïû¨)")[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS points ([m
[31m-                    user_id TEXT PRIMARY KEY,[m
[31m-                points INTEGER DEFAULT 0,[m
[31m-                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS orders ([m
[31m-                    order_id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    user_id TEXT NOT NULL,[m
[31m-                    service_id TEXT NOT NULL,[m
[31m-                    link TEXT NOT NULL,[m
[31m-                    quantity INTEGER NOT NULL,[m
[31m-                    price REAL NOT NULL,[m
[31m-                    total_price REAL,[m
[31m-                    discount_amount REAL DEFAULT 0,[m
[31m-                    referral_code TEXT,[m
[31m-                    status TEXT DEFAULT 'pending_payment',[m
[31m-                    external_order_id TEXT,[m
[31m-                    platform TEXT,[m
[31m-                    service_name TEXT,[m
[31m-                    comments TEXT,[m
[31m-                    smm_panel_order_id TEXT,[m
[31m-                    last_status_check TIMESTAMP,[m
[31m-                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[31m-            )[m
[31m-            """)[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS point_purchases ([m
[31m-                    id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    user_id TEXT NOT NULL,[m
[31m-                    amount INTEGER NOT NULL,[m
[31m-                    price REAL NOT NULL,[m
[31m-                    status TEXT DEFAULT 'pending',[m
[31m-                    buyer_name TEXT,[m
[31m-                    bank_info TEXT,[m
[31m-                    purchase_id TEXT UNIQUE,[m
[31m-                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[31m-            )[m
[31m-            """)[m
[31m-            [m
[31m-            # ÏòàÏïΩ Ï£ºÎ¨∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (SQLite)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS scheduled_orders ([m
[31m-                    id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    user_id TEXT NOT NULL,[m
[31m-                    service_id TEXT NOT NULL,[m
[31m-                    link TEXT NOT NULL,[m
[31m-                    quantity INTEGER NOT NULL,[m
[31m-                    price REAL NOT NULL,[m
[31m-                    scheduled_datetime TEXT NOT NULL,[m
[31m-                    status TEXT DEFAULT 'pending',[m
[31m-                    package_steps TEXT,[m
[31m-                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    processed_at TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ ÏòàÏïΩ Ï£ºÎ¨∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (SQLite)")[m
[31m-            [m
[31m-            # Ìå®ÌÇ§ÏßÄ ÏßÑÌñâ ÏÉÅÌô© ÌÖåÏù¥Î∏î ÏÉùÏÑ± (SQLite)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS package_progress ([m
[31m-                    id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    order_id TEXT NOT NULL,[m
[31m-                    step_number INTEGER NOT NULL,[m
[31m-                    step_name TEXT NOT NULL,[m
[31m-                    service_id TEXT NOT NULL,[m
[31m-                    quantity INTEGER NOT NULL,[m
[31m-                    smm_panel_order_id TEXT,[m
[31m-                    status TEXT DEFAULT 'pending',[m
[31m-                    error_message TEXT,[m
[31m-                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    completed_at TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ Ìå®ÌÇ§ÏßÄ ÏßÑÌñâ ÏÉÅÌô© ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (SQLite)")[m
[31m-            [m
[31m-            # Í≥µÏßÄÏÇ¨Ìï≠ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (SQLite)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS notices ([m
[31m-                    id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    title TEXT NOT NULL,[m
[31m-                    content TEXT NOT NULL,[m
[31m-                    image_url TEXT,[m
[31m-                    is_active INTEGER DEFAULT 1,[m
[31m-                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (SQLite)")[m
[31m-            [m
[31m-            # Î∏îÎ°úÍ∑∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (SQLite)[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS blog_posts ([m
[31m-                    id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    title TEXT NOT NULL,[m
[31m-                    content TEXT NOT NULL,[m
[31m-                    excerpt TEXT,[m
[31m-                    category TEXT,[m
[31m-                    thumbnail_url TEXT,[m
[31m-                    tags TEXT DEFAULT '[]',[m
[31m-                    is_published INTEGER DEFAULT 0,[m
[31m-                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    view_count INTEGER DEFAULT 0[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ Î∏îÎ°úÍ∑∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (SQLite)")[m
[31m-            [m
[31m-            # commission_ledger ÌÖåÏù¥Î∏î ÏÉùÏÑ± (SQLite) - ÌÜµÌï© ÌÖåÏù¥Î∏î[m
[31m-            cursor.execute("""[m
[31m-                CREATE TABLE IF NOT EXISTS commission_ledger ([m
[31m-                    ledger_id INTEGER PRIMARY KEY AUTOINCREMENT,[m
[31m-                    referral_code TEXT NOT NULL,[m
[31m-                    referrer_user_id TEXT NOT NULL,[m
[31m-                    referred_user_id TEXT,[m
[31m-                    order_id TEXT,[m
[31m-                    event TEXT NOT NULL CHECK (event IN ('earn','payout','adjust','reverse')),[m
[31m-                    base_amount REAL,[m
[31m-                    commission_rate REAL,[m
[31m-                    amount REAL NOT NULL,[m
[31m-                    status TEXT NOT NULL DEFAULT 'confirmed' CHECK (status IN ('pending','confirmed','cancelled')),[m
[31m-                    notes TEXT,[m
[31m-                    external_ref TEXT,[m
[31m-                    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,[m
[31m-                    confirmed_at TEXT[m
[31m-                )[m
[31m-            """)[m
[31m-            print("‚úÖ commission_ledger ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å (SQLite - ÌÜµÌï© ÌÖåÏù¥Î∏î)")[m
[31m-            [m
[31m-            # commission_ledger Ïù∏Îç±Ïä§ ÏÉùÏÑ± (SQLite)[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_code_time ON commission_ledger(referral_code, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_owner_time ON commission_ledger(referrer_user_id, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_event_time ON commission_ledger(event, created_at)")[m
[31m-            cursor.execute("CREATE INDEX IF NOT EXISTS idx_ledger_order ON commission_ledger(order_id)")[m
[31m-            print("‚úÖ commission_ledger Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å (SQLite)")[m
[31m-        [m
[31m-        # Ìä∏ÎûúÏû≠ÏÖò Ï§ëÎã® Ïò§Î•ò Ï≤¥ÌÅ¨ Î∞è Î≥µÍµ¨[m
[31m-        try:[m
[31m-            conn.commit()[m
[31m-            print("‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÖåÏù¥Î∏î Ï¥àÍ∏∞Ìôî ÏôÑÎ£å")[m
[31m-        except Exception as commit_error:[m
[31m-            error_str = str(commit_error).lower()[m
[31m-            if 'current transaction is aborted' in error_str or 'aborted' in error_str:[m
[31m-                print("‚ö†Ô∏è Ìä∏ÎûúÏû≠ÏÖò Ï§ëÎã® Í∞êÏßÄ, Î°§Î∞± ÌõÑ Í≥ÑÏÜç ÏßÑÌñâ...")[m
[31m-                try:[m
[31m-                    conn.rollback()[m
[31m-                    # Î°§Î∞± ÌõÑ Îã§Ïãú Ïª§Î∞ã ÏãúÎèÑ (Ïù¥ÎØ∏ Ïª§Î∞ãÎêú ÏûëÏóÖÏùÄ Î°§Î∞±ÎêòÏßÄ ÏïäÏùå)[m
[31m-                    try:[m
[31m-                        conn.commit()[m
[31m-                    except:[m
[31m-                        pass[m
[31m-                    print("‚úÖ Ìä∏ÎûúÏû≠ÏÖò Î°§Î∞± ÏôÑÎ£å, Í≥ÑÏÜç ÏßÑÌñâ")[m
[31m-                except Exception as rollback_error:[m
[31m-                    print(f"‚ö†Ô∏è Î°§Î∞± Ïã§Ìå® (Î¨¥Ïãú): {rollback_error}")[m
[31m-            else:[m
[31m-                print(f"‚ö†Ô∏è Ïª§Î∞ã Ïò§Î•ò (Í≥ÑÏÜç ÏßÑÌñâ): {commit_error}")[m
[31m-                try:[m
[31m-                    conn.rollback()[m
[31m-                except:[m
[31m-                    pass[m
[31m-        [m
[31m-        # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïù∏Îç±Ïä§ ÏÉùÏÑ± (ÏÑ±Îä• ÏµúÏ†ÅÌôî)[m
[31m-        print("üîç Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ï§ë...")[m
[31m-        [m
[31m-        if is_postgresql:[m
[31m-            # PostgreSQL Ïù∏Îç±Ïä§[m
[31m-            indexes = [[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_order_id ON orders(order_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_points_user_id ON points(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_point_purchases_user_id ON point_purchases(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_point_purchases_status ON point_purchases(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_referral_codes_code ON referral_codes(code)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_referral_codes_user_email ON referral_codes(user_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_user_id ON scheduled_orders(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_status ON scheduled_orders(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_datetime ON scheduled_orders(scheduled_datetime)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_package_progress_order_id ON package_progress(order_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_package_progress_status ON package_progress(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_split_delivery_order_id ON split_delivery_progress(order_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_commission_points_email ON commission_points(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_commission_transactions_email ON commission_point_transactions(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_email ON commission_withdrawal_requests(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_status ON commission_withdrawal_requests(status)"[m
[31m-            ][m
[32m+[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            """[m
[32m+[m[32m            SELECT table_name[m
[32m+[m[32m            FROM information_schema.tables[m
[32m+[m[32m            WHERE table_schema = 'public'[m
[32m+[m[32m            """[m
[32m+[m[32m        )[m
[32m+[m[32m        existing_tables = {row[0] for row in cursor.fetchall()}[m
[32m+[m
[32m+[m[32m        missing_tables = sorted(required_tables - existing_tables)[m
[32m+[m[32m        if missing_tables:[m
[32m+[m[32m            message = f"ÌïÑÏàò ÌÖåÏù¥Î∏îÏù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§: {', '.join(missing_tables)}"[m
[32m+[m[32m            print(f"‚ùå {message}")[m
[32m+[m[32m            raise RuntimeError(message)[m
[32m+[m
[32m+[m[32m        print("‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌïÑÏàò ÌÖåÏù¥Î∏î ÌôïÏù∏ ÏôÑÎ£å")[m
[32m+[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            """[m
[32m+[m[32m            SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1[m
[32m+[m[32m            """[m
[32m+[m[32m        )[m
[32m+[m[32m        latest_migration = cursor.fetchone()[m
[32m+[m[32m        if latest_migration:[m
[32m+[m[32m            print(f"üì¶ ÏµúÏã† ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î≤ÑÏ†Ñ: {latest_migration[0]}")[m
         else:[m
[31m-            # SQLite Ïù∏Îç±Ïä§[m
[31m-            indexes = [[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_points_user_id ON points(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_point_purchases_user_id ON point_purchases(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_point_purchases_status ON point_purchases(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_referral_codes_code ON referral_codes(code)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_referral_codes_user_email ON referral_codes(user_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_user_id ON scheduled_orders(user_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_status ON scheduled_orders(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_scheduled_orders_datetime ON scheduled_orders(scheduled_datetime)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_package_progress_order_id ON package_progress(order_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_package_progress_status ON package_progress(status)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_split_delivery_order_id ON split_delivery_progress(order_id)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_commission_points_email ON commission_points(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_commission_transactions_email ON commission_point_transactions(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_email ON commission_withdrawal_requests(referrer_email)",[m
[31m-                "CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_status ON commission_withdrawal_requests(status)"[m
[31m-            ][m
[31m-        [m
[31m-        for index_sql in indexes:[m
[31m-            try:[m
[31m-                cursor.execute(index_sql)[m
[31m-                index_name = index_sql.split('idx_')[1].split(' ')[0][m
[31m-                print(f"‚úÖ Ïù∏Îç±Ïä§ ÏÉùÏÑ±: {index_name}")[m
[31m-            except Exception as e:[m
[31m-                index_name = index_sql.split('idx_')[1].split(' ')[0][m
[31m-                print(f"‚ö†Ô∏è Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ïã§Ìå® (Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï† Ïàò ÏûàÏùå): {index_name} - {e}")[m
[31m-        [m
[32m+[m[32m            print("‚ö†Ô∏è schema_migrations ÌÖåÏù¥Î∏îÏù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. migrate_database.py Ïã§Ìñâ Ïó¨Î∂ÄÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.")[m
[32m+[m
         conn.commit()[m
[31m-        print("‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å")[m
[31m-            [m
[31m-    except Exception as e:[m
[31m-        print(f"‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: {e}")[m
[31m-        import traceback[m
[31m-        traceback.print_exc()[m
[32m+[m[32m    except Exception as exc:[m
         if conn:[m
[31m-            try:[m
[31m-                conn.rollback()[m
[31m-            except:[m
[31m-                pass[m
[32m+[m[32m            conn.rollback()[m
[32m+[m[32m        print(f"‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®: {exc}")[m
[32m+[m[32m        raise[m
     finally:[m
[32m+[m[32m        if cursor:[m
[32m+[m[32m            cursor.close()[m
         if conn:[m
[31m-            try:[m
[31m-                conn.close()[m
[31m-            except:[m
[31m-                pass[m
[32m+[m[32m            conn.close()[m
 [m
 # Ïï± ÏãúÏûë Ïãú Ï¥àÍ∏∞Ìôî[m
 def initialize_app():[m
[36m@@ -2907,49 +2293,44 @@[m [mdef register():[m
 # ÏÇ¨Ïö©Ïûê Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå[m
 @app.route('/api/points', methods=['GET'])[m
 def get_user_points():[m
[31m-    """ÏÇ¨Ïö©Ïûê Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå"""[m
[32m+[m[32m    """ÏÇ¨Ïö©Ïûê ÏßÄÍ∞ë(Ìè¨Ïù∏Ìä∏) ÏûîÏï° Ï°∞Ìöå"""[m
     conn = None[m
     cursor = None[m
[31m-    [m
[32m+[m
     try:[m
[31m-        user_id = request.args.get('user_id')[m
[31m-        print(f"üîç Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå ÏöîÏ≤≠ - user_id: {user_id}")[m
[31m-        [m
[31m-        if not user_id:[m
[31m-            print(f"‚ùå user_id ÎàÑÎùΩ")[m
[32m+[m[32m        raw_user_id = request.args.get('user_id')[m
[32m+[m[32m        if not raw_user_id:[m
             return jsonify({'error': 'user_idÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.'}), 400[m
[31m-        [m
[32m+[m
[32m+[m[32m        identifier = parse_user_identifier(raw_user_id)[m
[32m+[m
         conn = get_db_connection()[m
[31m-        cursor = conn.cursor()[m
[31m-        [m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            cursor.execute("SELECT points FROM points WHERE user_id = %s", (user_id,))[m
[31m-        else:[m
[31m-            cursor.execute("SELECT points FROM points WHERE user_id = ?", (user_id,))[m
[31m-        [m
[31m-        result = cursor.fetchone()[m
[31m-        [m
[31m-        if result:[m
[31m-            points = result[0] if isinstance(result, tuple) else result['points'][m
[31m-            print(f"‚úÖ Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå ÏÑ±Í≥µ: {points}")[m
[31m-        else:[m
[31m-            points = 0[m
[31m-            print(f"‚ÑπÔ∏è Ìè¨Ïù∏Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå, Í∏∞Î≥∏Í∞í 0 ÏÑ§Ï†ï")[m
[31m-        [m
[32m+[m[32m        cursor = conn.cursor(cursor_factory=RealDictCursor)[m
[32m+[m
[32m+[m[32m        user = ensure_user_record(cursor, identifier)[m
[32m+[m[32m        wallet = ensure_wallet_record(cursor, user['user_id'])[m
[32m+[m
[32m+[m[32m        conn.commit()[m
[32m+[m
[32m+[m[32m        balance = decimal_to_float(wallet['balance']) if wallet else 0.0[m
[32m+[m
         return jsonify({[m
[31m-            'user_id': user_id,[m
[31m-            'points': points[m
[32m+[m[32m            'user_id': user['user_id'],[m
[32m+[m[32m            'external_uid': user['external_uid'],[m
[32m+[m[32m            'points': balance,[m
[32m+[m[32m            'wallet_balance': balance,[m
         }), 200[m
[31m-        [m
[32m+[m
     except Exception as e:[m
[31m-        print(f"‚ùå Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå Ïò§Î•ò: {e}")[m
[31m-        return jsonify({'error': f'Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
[32m+[m[32m        if conn:[m
[32m+[m[32m            conn.rollback()[m
[32m+[m[32m        print(f"‚ùå ÏßÄÍ∞ë ÏûîÏï° Ï°∞Ìöå Ïò§Î•ò: {e}")[m
[32m+[m[32m        return jsonify({'error': f'ÏßÄÍ∞ë ÏûîÏï° Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
     finally:[m
         if cursor:[m
             cursor.close()[m
         if conn:[m
             conn.close()[m
[31m-[m
 # Ï£ºÎ¨∏ ÏÉùÏÑ±[m
 @app.route('/api/orders', methods=['POST'])[m
 def create_order():[m
[36m@@ -3710,201 +3091,96 @@[m [mdef get_orders():[m
         if conn:[m
             conn.close()[m
         print("‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ï¢ÖÎ£å")[m
[31m-[m
 # Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠[m
 @app.route('/api/points/purchase', methods=['POST'])[m
 def purchase_points():[m
[31m-    """Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠"""[m
[32m+[m[32m    """Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ÏùÑ Îì±Î°ùÌïòÍ≥† ÏßÄÍ∞ë Ìä∏ÎûúÏû≠ÏÖòÏúºÎ°ú Í∏∞Î°ù"""[m
[32m+[m[32m    conn = None[m
[32m+[m[32m    cursor = None[m
[32m+[m
     try:[m
[31m-        data = request.get_json()[m
[31m-        user_id = data.get('user_id')[m
[31m-        amount = data.get('amount')[m
[31m-        price = data.get('price')[m
[31m-        buyer_name = data.get('buyer_name', '')[m
[31m-        bank_info = data.get('bank_info', '')[m
[31m-        [m
[31m-        # ÏûÖÎ†• Í≤ÄÏ¶ù Í∞ïÌôî[m
[31m-        if not all([user_id, amount, price]):[m
[31m-            return jsonify({'error': 'ÌïÑÏàò ÌïÑÎìúÍ∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.'}), 400[m
[31m-        [m
[31m-        # Í∏àÏï° Í≤ÄÏ¶ù[m
[32m+[m[32m        data = request.get_json(force=True)[m
[32m+[m
[32m+[m[32m        raw_user_id = data.get('user_id')[m
[32m+[m[32m        if raw_user_id is None:[m
[32m+[m[32m            return jsonify({'error': 'user_idÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.'}), 400[m
[32m+[m
         try:[m
[31m-            amount = float(amount)[m
[31m-            price = float(price)[m
[31m-        except (ValueError, TypeError):[m
[31m-            return jsonify({'error': 'ÏûòÎ™ªÎêú Í∏àÏï° ÌòïÏãùÏûÖÎãàÎã§.'}), 400[m
[31m-        [m
[31m-        # Í∏àÏï° Î≤îÏúÑ Í≤ÄÏ¶ù[m
[31m-        if amount <= 0 or amount > 1000000:  # ÏµúÎåÄ 100Îßå Ìè¨Ïù∏Ìä∏[m
[31m-            return jsonify({'error': 'Ìè¨Ïù∏Ìä∏ Í∏àÏï°Ïù¥ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇ¨ÏäµÎãàÎã§.'}), 400[m
[31m-        [m
[31m-        if price <= 0 or price > 10000000:  # ÏµúÎåÄ 1Ï≤úÎßåÏõê[m
[31m-            return jsonify({'error': 'Í≤∞Ï†ú Í∏àÏï°Ïù¥ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇ¨ÏäµÎãàÎã§.'}), 400[m
[31m-        [m
[31m-        # ÏÇ¨Ïö©Ïûê ID Í≤ÄÏ¶ù (SQL Ïù∏Ï†ùÏÖò Î∞©ÏßÄ) - Íµ¨Í∏Ä/Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÎèÑ ÌóàÏö©[m
[31m-        user_id_str = str(user_id)  # Ï†ïÏàòÌòï user_idÎ•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò[m
[31m-        if not user_id_str.replace('_', '').replace('-', '').replace('google', '').replace('kakao', '').isalnum():[m
[31m-            return jsonify({'error': 'ÏûòÎ™ªÎêú ÏÇ¨Ïö©Ïûê ID ÌòïÏãùÏûÖÎãàÎã§.'}), 400[m
[31m-        [m
[32m+[m[32m            amount_decimal = to_decimal(data.get('amount'))[m
[32m+[m[32m            price_decimal = to_decimal(data.get('price'))[m
[32m+[m[32m        except (TypeError, ValueError, decimal.InvalidOperation):[m
[32m+[m[32m            return jsonify({'error': 'amountÏôÄ priceÎäî Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m
[32m+[m[32m        if amount_decimal <= 0:[m
[32m+[m[32m            return jsonify({'error': 'Ìè¨Ïù∏Ìä∏ Í∏àÏï°ÏùÄ 0Î≥¥Îã§ Ïª§Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m[32m        if price_decimal <= 0:[m
[32m+[m[32m            return jsonify({'error': 'Í≤∞Ï†ú Í∏àÏï°ÏùÄ 0Î≥¥Îã§ Ïª§Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m
[32m+[m[32m        buyer_name = (data.get('buyer_name') or '').strip()[m
[32m+[m[32m        bank_info = (data.get('bank_info') or '').strip()[m
[32m+[m
[32m+[m[32m        identifier = parse_user_identifier(raw_user_id)[m
[32m+[m
         conn = get_db_connection()[m
[31m-        cursor = conn.cursor()[m
[31m-        [m
[31m-        # ÏÇ¨Ïö©ÏûêÍ∞Ä users ÌÖåÏù¥Î∏îÏóê ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥†, ÏóÜÏúºÎ©¥ ÏÉùÏÑ±[m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            # PostgreSQL: user_idÎäî VARCHARÏù¥ÎØÄÎ°ú ÌÉÄÏûÖ Ï∫êÏä§ÌåÖ Î∂àÌïÑÏöî[m
[31m-            # emailÏù¥ NOT NULLÏù¥ÎØÄÎ°ú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï[m
[31m-            sanitized_user_id = ([m
[31m-                user_id_str[m
[31m-                .replace('@', '_at_')[m
[31m-                .replace('/', '_')[m
[31m-                .replace('\\', '_')[m
[32m+[m[32m        cursor = conn.cursor(cursor_factory=RealDictCursor)[m
[32m+[m
[32m+[m[32m        user = ensure_user_record([m
[32m+[m[32m            cursor,[m
[32m+[m[32m            identifier,[m
[32m+[m[32m            email=data.get('user_email'),[m
[32m+[m[32m            username=data.get('username') or buyer_name or identifier.get('external_uid')[m
[32m+[m[32m        )[m
[32m+[m[32m        wallet = ensure_wallet_record(cursor, user['user_id'])[m
[32m+[m
[32m+[m[32m        metadata = {[m
[32m+[m[32m            'requested_points': float(amount_decimal),[m
[32m+[m[32m            'payment_amount': float(price_decimal),[m
[32m+[m[32m            'buyer_name': buyer_name,[m
[32m+[m[32m            'bank_info': bank_info,[m
[32m+[m[32m            'channel': data.get('channel') or 'manual',[m
[32m+[m[32m            'memo': data.get('memo') or data.get('note')[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            """[m
[32m+[m[32m            INSERT INTO wallet_transactions ([m
[32m+[m[32m                wallet_id, type, amount, status, meta_json, locked, created_at, updated_at[m
             )[m
[31m-            user_email = data.get('user_email', '') or f"{sanitized_user_id[:200]}@temp.local"[m
[31m-            [m
[31m-            # ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±/ÌôïÏù∏ (ON CONFLICTÎ°ú Ï§ëÎ≥µ Î∞©ÏßÄ - ÏõêÏûêÏ†Å Ïó∞ÏÇ∞)[m
[31m-            # Í∞ôÏùÄ Ìä∏ÎûúÏû≠ÏÖò ÎÇ¥ÏóêÏÑú ÏÇ¨Ïö©ÏûêÏôÄ pointsÎ•º Î™®Îëê ÏÉùÏÑ±Ìï¥Ïïº Ïô∏Îûò ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÌÜµÍ≥º[m
[31m-            import sys[m
[31m-            import traceback[m
[31m-            import time[m
[31m-            try:[m
[31m-                # Î®ºÏ†Ä ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏[m
[31m-                cursor.execute("SELECT user_id FROM users WHERE user_id = %s", (user_id_str,))[m
[31m-                user_exists = cursor.fetchone()[m
[31m-                [m
[31m-                if not user_exists:[m
[31m-                    # Ïù¥Î©îÏùºÏù¥ Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ÏßÄ ÌôïÏù∏[m
[31m-                    cursor.execute("SELECT user_id FROM users WHERE email = %s", (user_email,))[m
[31m-                    email_exists = cursor.fetchone()[m
[31m-                    [m
[31m-                    if email_exists:[m
[31m-                        alt_id = ([m
[31m-                            user_id_str[m
[31m-                            .replace('@', '_at_')[m
[31m-                            .replace('/', '_')[m
[31m-                            .replace('\\', '_')[m
[31m-                        )[m
[31m-                        user_email = f"{alt_id[:150]}_{int(time.time())}@temp.local"[m
[31m-                        print(f"‚ö†Ô∏è Ïù¥Î©îÏùº Ï∂©Îèå Í∞êÏßÄ, Í≥†Ïú† Ïù¥Î©îÏùº ÏÉùÏÑ±: {user_email}", flush=True)[m
[31m-                    [m
[31m-                    # ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± (Ïù¥Î©îÏùº Ï∂©Îèå Î∞©ÏßÄÎ•º ÏúÑÌï¥ Í≥†Ïú† Ïù¥Î©îÏùº ÏÇ¨Ïö©)[m
[31m-                    try:[m
[31m-                        cursor.execute("""[m
[31m-                            INSERT INTO users (user_id, email, name, created_at, updated_at)[m
[31m-                            VALUES (%s, %s, %s, NOW(), NOW())[m
[31m-                            ON CONFLICT (user_id) DO NOTHING[m
[31m-                        """, (user_id_str, user_email, buyer_name or 'User'))[m
[31m-                        print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± ÏãúÎèÑ: {user_id_str}, email: {user_email}", flush=True)[m
[31m-                    except Exception as insert_error:[m
[31m-                        # Ïù¥Î©îÏùº unique Ï†úÏïΩ Ï°∞Í±¥ ÏúÑÎ∞ò Îì± ÏòàÏô∏ Ï≤òÎ¶¨[m
[31m-                        error_str = str(insert_error).lower()[m
[31m-                        if 'unique' in error_str or 'duplicate' in error_str or 'violates unique constraint' in error_str:[m
[31m-                            # Ïù¥Î©îÏùº Ï∂©ÎèåÏù¥ Î∞úÏÉùÌïú Í≤ΩÏö∞, Îçî Í≥†Ïú†Ìïú Ïù¥Î©îÏùºÎ°ú Ïû¨ÏãúÎèÑ[m
[31m-                            alt_id = ([m
[31m-                                user_id_str[m
[31m-                                .replace('@', '_at_')[m
[31m-                                .replace('/', '_')[m
[31m-                                .replace('\\', '_')[m
[31m-                            )[m
[31m-                            user_email = f"{alt_id[:120]}_{int(time.time() * 1000)}@temp.local"[m
[31m-                            print(f"‚ö†Ô∏è Ïù¥Î©îÏùº Ï∂©Îèå Î∞úÏÉù, Ïû¨ÏãúÎèÑ: {user_email}", flush=True)[m
[31m-                            cursor.execute("""[m
[31m-                                INSERT INTO users (user_id, email, name, created_at, updated_at)[m
[31m-                                VALUES (%s, %s, %s, NOW(), NOW())[m
[31m-                                ON CONFLICT (user_id) DO NOTHING[m
[31m-                            """, (user_id_str, user_email, buyer_name or 'User'))[m
[31m-                            print(f"‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ: {user_id_str}", flush=True)[m
[31m-                        else:[m
[31m-                            # Îã§Î•∏ Ï¢ÖÎ•òÏùò Ïò§Î•òÎäî Í∑∏ÎåÄÎ°ú Ï†ÑÌåå[m
[31m-                            raise[m
[31m-                [m
[31m-                # ÏÇ¨Ïö©Ïûê Ï°¥Ïû¨ ÌôïÏù∏ (Î∞òÎìúÏãú ÌïÑÏöî)[m
[31m-                cursor.execute("SELECT user_id FROM users WHERE user_id = %s", (user_id_str,))[m
[31m-                if not cursor.fetchone():[m
[31m-                    raise Exception(f"ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ïã§Ìå®: {user_id_str}Í∞Ä users ÌÖåÏù¥Î∏îÏóê Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.")[m
[31m-                print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÌôïÏù∏ ÏôÑÎ£å: {user_id_str}", flush=True)[m
[31m-                [m
[31m-                # Í∞ôÏùÄ Ìä∏ÎûúÏû≠ÏÖò ÎÇ¥ÏóêÏÑú points Î†àÏΩîÎìú ÏÉùÏÑ± (Ïô∏Îûò ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥Ïù¥ Ï†ÅÏö©Îê®)[m
[31m-                cursor.execute("""[m
[31m-                    INSERT INTO points (user_id, points, created_at, updated_at)[m
[31m-                    VALUES (%s, 0, NOW(), NOW())[m
[31m-                    ON CONFLICT (user_id) DO NOTHING[m
[31m-                """, (user_id_str,))[m
[31m-                print(f"‚úÖ Ìè¨Ïù∏Ìä∏ Î†àÏΩîÎìú ÏÉùÏÑ±/ÌôïÏù∏ ÏôÑÎ£å: {user_id_str}", flush=True)[m
[31m-                [m
[31m-                # Ìè¨Ïù∏Ìä∏ Î†àÏΩîÎìú Ï°¥Ïû¨ ÌôïÏù∏[m
[31m-                cursor.execute("SELECT user_id FROM points WHERE user_id = %s", (user_id_str,))[m
[31m-                if not cursor.fetchone():[m
[31m-                    raise Exception(f"Ìè¨Ïù∏Ìä∏ Î†àÏΩîÎìú ÏÉùÏÑ± Ïã§Ìå®: {user_id_str}Í∞Ä points ÌÖåÏù¥Î∏îÏóê Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.")[m
[31m-                [m
[31m-                # Í∞ôÏùÄ Ìä∏ÎûúÏû≠ÏÖò ÎÇ¥ÏóêÏÑú point_purchases ÏÇΩÏûÖ[m
[31m-                cursor.execute("""[m
[31m-                    INSERT INTO point_purchases (user_id, amount, price, status, buyer_name, bank_info, created_at, updated_at)[m
[31m-                    VALUES (%s, %s, %s, 'pending', %s, %s, NOW(), NOW())[m
[31m-                    RETURNING id[m
[31m-                """, (user_id_str, amount, price, buyer_name, bank_info))[m
[31m-                purchase_id = cursor.fetchone()[0][m
[31m-                print(f"‚úÖ Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ ÏÇΩÏûÖ ÏôÑÎ£å: purchase_id={purchase_id}, user_id={user_id_str}", flush=True)[m
[31m-                [m
[31m-            except Exception as db_error:[m
[31m-                conn.rollback()[m
[31m-                error_msg = f"‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏûëÏóÖ Ïã§Ìå®: {db_error}"[m
[31m-                print(error_msg, file=sys.stderr, flush=True)[m
[31m-                traceback.print_exc(file=sys.stderr)[m
[31m-                sys.stderr.flush()[m
[31m-                raise Exception(f"Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏûëÏóÖ Ïã§Ìå®: {db_error}")[m
[31m-        else:[m
[31m-            # SQLite: ÏÇ¨Ïö©ÏûêÍ∞Ä users ÌÖåÏù¥Î∏îÏóê ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥†, ÏóÜÏúºÎ©¥ ÏÉùÏÑ±[m
[31m-            sanitized_user_id = user_id_str.replace('@', '_at_').replace('/', '_').replace('\\', '_')[m
[31m-            user_email = data.get('user_email', '') or f"{sanitized_user_id[:200]}@temp.local"[m
[31m-            [m
[31m-            # ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±/ÌôïÏù∏ (INSERT OR IGNOREÎ°ú Ï§ëÎ≥µ Î∞©ÏßÄ)[m
[31m-            cursor.execute("""[m
[31m-                INSERT OR IGNORE INTO users (user_id, email, name, created_at, updated_at)[m
[31m-                VALUES (?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)[m
[31m-            """, (user_id_str, user_email, buyer_name or 'User'))[m
[31m-            [m
[31m-            # points ÌÖåÏù¥Î∏îÏóêÎèÑ Ï¥àÍ∏∞ Î†àÏΩîÎìú ÏÉùÏÑ± (INSERT OR IGNOREÎ°ú Ï§ëÎ≥µ Î∞©ÏßÄ)[m
[31m-            cursor.execute("""[m
[31m-                INSERT OR IGNORE INTO points (user_id, points, created_at, updated_at)[m
[31m-                VALUES (?, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)[m
[31m-            """, (user_id_str,))[m
[31m-            [m
[31m-            print(f"‚úÖ ÏÇ¨Ïö©Ïûê Î∞è Ìè¨Ïù∏Ìä∏ Î†àÏΩîÎìú ÌôïÏù∏/ÏÉùÏÑ± ÏôÑÎ£å: {user_id_str}")[m
[31m-            [m
[31m-            cursor.execute("""[m
[31m-                INSERT INTO point_purchases (user_id, amount, price, status, buyer_name, bank_info, created_at, updated_at)[m
[31m-                VALUES (?, ?, ?, 'pending', ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)[m
[31m-            """, (user_id_str, amount, price, buyer_name, bank_info))[m
[31m-            cursor.execute("SELECT last_insert_rowid()")[m
[31m-            purchase_id = cursor.fetchone()[0][m
[31m-        [m
[31m-        # PostgreSQLÏùò Í≤ΩÏö∞ purchase_idÎäî Ïù¥ÎØ∏ try Î∏îÎ°ùÏóêÏÑú ÏÑ§Ï†ïÎê®[m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            # purchase_idÎäî Ïù¥ÎØ∏ ÏúÑÏùò try Î∏îÎ°ùÏóêÏÑú ÏÑ§Ï†ïÎêòÏóàÏúºÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå[m
[31m-            pass[m
[31m-        [m
[31m-        # Î™®Îì† ÏûëÏóÖÏù¥ ÏÑ±Í≥µÌñàÏúºÎ©¥ Ìïú Î≤àÏóê commit[m
[32m+[m[32m            VALUES (%s, 'topup', %s, 'pending', %s, FALSE, NOW(), NOW())[m
[32m+[m[32m            RETURNING transaction_id, wallet_id, status, created_at, updated_at[m
[32m+[m[32m            """,[m
[32m+[m[32m            ([m
[32m+[m[32m                wallet['wallet_id'],[m
[32m+[m[32m                amount_decimal,[m
[32m+[m[32m                json.dumps(metadata, ensure_ascii=False)[m
[32m+[m[32m            )[m
[32m+[m[32m        )[m
[32m+[m[32m        transaction = cursor.fetchone()[m
[32m+[m
         conn.commit()[m
[31m-        [m
[31m-        print(f"‚úÖ Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠ ÏôÑÎ£å - purchase_id: {purchase_id}, user_id: {user_id_str}")[m
[31m-        [m
[31m-        conn.close()[m
[31m-        [m
[32m+[m
         return jsonify({[m
             'success': True,[m
[31m-            'purchase_id': purchase_id,[m
[31m-            'status': 'pending',[m
[31m-            'message': 'Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.'[m
[32m+[m[32m            'message': 'Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.',[m
[32m+[m[32m            'transaction_id': transaction['transaction_id'],[m
[32m+[m[32m            'status': transaction['status'],[m
[32m+[m[32m            'requested_points': float(amount_decimal),[m
[32m+[m[32m            'payment_amount': float(price_decimal),[m
[32m+[m[32m            'wallet_balance': decimal_to_float(wallet['balance'])[m
         }), 200[m
[31m-        [m
[32m+[m
     except Exception as e:[m
[31m-        import sys[m
[32m+[m[32m        if conn:[m
[32m+[m[32m            conn.rollback()[m
[32m+[m[32m        print(f"‚ùå Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ Ïã§Ìå®: {e}")[m
         import traceback[m
[31m-        error_msg = f'Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠ Ïã§Ìå®: {str(e)}'[m
[31m-        print(f"‚ùå Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠ Ïã§Ìå®: {error_msg}", file=sys.stderr, flush=True)[m
[31m-        traceback.print_exc(file=sys.stderr)[m
[31m-        sys.stderr.flush()[m
[31m-        return jsonify({'error': error_msg}), 500[m
[32m+[m[32m        traceback.print_exc()[m
[32m+[m[32m        return jsonify({'error': f'Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ Ïã§Ìå®: {str(e)}'}), 500[m
[32m+[m[32m    finally:[m
[32m+[m[32m        if cursor:[m
[32m+[m[32m            cursor.close()[m
[32m+[m[32m        if conn:[m
[32m+[m[32m            conn.close()[m
 [m
 # KCP ÌëúÏ§ÄÍ≤∞Ï†ú - Í±∞ÎûòÎì±Î°ù (Mobile)[m
 @app.route('/api/points/purchase-kcp/register', methods=['POST'])[m
[36m@@ -4471,101 +3747,95 @@[m [mdef get_admin_purchases():[m
         [m
     except Exception as e:[m
         return jsonify({'error': f'Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
[32m+[m[32m# Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ Ïã†Ï≤≠[m
[32m+[m[32m@app.route('/api/points/purchase', methods=['POST'])[m
[32m+[m[32mdef purchase_points():[m
[32m+[m[32m    """Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ÏùÑ Îì±Î°ùÌïòÍ≥† ÏßÄÍ∞ë Ìä∏ÎûúÏû≠ÏÖòÏúºÎ°ú Í∏∞Î°ù"""[m
[32m+[m[32m    conn = None[m
[32m+[m[32m    cursor = None[m
 [m
[31m-# Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ ÏäπÏù∏/Í±∞Ï†à[m
[31m-@app.route('/api/admin/purchases/<int:purchase_id>', methods=['PUT'])[m
[31m-def update_purchase_status(purchase_id):[m
[31m-    """Ìè¨Ïù∏Ìä∏ Íµ¨Îß§ ÏäπÏù∏/Í±∞Ï†à"""[m
     try:[m
[31m-        data = request.get_json()[m
[31m-        status = data.get('status')  # 'approved' ÎòêÎäî 'rejected'[m
[31m-        [m
[31m-        if status not in ['approved', 'rejected']:[m
[31m-            return jsonify({'error': 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏûÖÎãàÎã§.'}), 400[m
[31m-        [m
[32m+[m[32m        data = request.get_json(force=True)[m
[32m+[m
[32m+[m[32m        raw_user_id = data.get('user_id')[m
[32m+[m[32m        if raw_user_id is None:[m
[32m+[m[32m            return jsonify({'error': 'user_idÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.'}), 400[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            amount_decimal = to_decimal(data.get('amount'))[m
[32m+[m[32m            price_decimal = to_decimal(data.get('price'))[m
[32m+[m[32m        except (TypeError, ValueError, decimal.InvalidOperation):[m
[32m+[m[32m            return jsonify({'error': 'amountÏôÄ priceÎäî Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m
[32m+[m[32m        if amount_decimal <= 0:[m
[32m+[m[32m            return jsonify({'error': 'Ìè¨Ïù∏Ìä∏ Í∏àÏï°ÏùÄ 0Î≥¥Îã§ Ïª§Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m[32m        if price_decimal <= 0:[m
[32m+[m[32m            return jsonify({'error': 'Í≤∞Ï†ú Í∏àÏï°ÏùÄ 0Î≥¥Îã§ Ïª§Ïïº Ìï©ÎãàÎã§.'}), 400[m
[32m+[m
[32m+[m[32m        buyer_name = (data.get('buyer_name') or '').strip()[m
[32m+[m[32m        bank_info = (data.get('bank_info') or '').strip()[m
[32m+[m
[32m+[m[32m        identifier = parse_user_identifier(raw_user_id)[m
[32m+[m
         conn = get_db_connection()[m
[31m-        cursor = conn.cursor()[m
[31m-        [m
[31m-        # Íµ¨Îß§ Ïã†Ï≤≠ Ï†ïÎ≥¥ Ï°∞Ìöå[m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            cursor.execute("""[m
[31m-                SELECT user_id, amount, status[m
[31m-                FROM point_purchases[m
[31m-                WHERE id = %s[m
[31m-            """, (purchase_id,))[m
[31m-        else:[m
[31m-            cursor.execute("""[m
[31m-                SELECT user_id, amount, status[m
[31m-                FROM point_purchases[m
[31m-                WHERE id = ?[m
[31m-            """, (purchase_id,))[m
[31m-        [m
[31m-        purchase = cursor.fetchone()[m
[31m-        [m
[31m-        if not purchase:[m
[31m-            return jsonify({'error': 'Íµ¨Îß§ Ïã†Ï≤≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'}), 404[m
[31m-        [m
[31m-        if purchase[2] != 'pending':[m
[31m-            return jsonify({'error': 'Ïù¥ÎØ∏ Ï≤òÎ¶¨Îêú Íµ¨Îß§ Ïã†Ï≤≠ÏûÖÎãàÎã§.'}), 400[m
[31m-        [m
[31m-        # ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏[m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-                cursor.execute("""[m
[31m-                UPDATE point_purchases[m
[31m-                SET status = %s, updated_at = CURRENT_TIMESTAMP[m
[31m-                WHERE id = %s[m
[31m-            """, (status, purchase_id))[m
[31m-        else:[m
[31m-            cursor.execute("""[m
[31m-                UPDATE point_purchases[m
[31m-                SET status = ?, updated_at = CURRENT_TIMESTAMP[m
[31m-                WHERE id = ?[m
[31m-            """, (status, purchase_id))[m
[31m-        [m
[31m-        # ÏäπÏù∏Îêú Í≤ΩÏö∞ ÏÇ¨Ïö©Ïûê Ìè¨Ïù∏Ìä∏ Ï¶ùÍ∞Ä[m
[31m-        if status == 'approved':[m
[31m-            user_id = purchase[0][m
[31m-            amount = purchase[1][m
[31m-            [m
[31m-            # ÏÇ¨Ïö©Ïûê Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå[m
[31m-            if DATABASE_URL.startswith('postgresql://'):[m
[31m-                cursor.execute("""[m
[31m-                    SELECT points FROM points WHERE user_id = %s[m
[31m-                """, (user_id,))[m
[31m-            else:[m
[31m-                cursor.execute("""[m
[31m-                    SELECT points FROM points WHERE user_id = ?[m
[31m-                """, (user_id,))[m
[31m-            [m
[31m-            user_points = cursor.fetchone()[m
[31m-            current_points = user_points[0] if user_points else 0[m
[31m-            new_points = current_points + amount[m
[31m-            [m
[31m-            # Ìè¨Ïù∏Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏[m
[31m-            if DATABASE_URL.startswith('postgresql://'):[m
[31m-                cursor.execute("""[m
[31m-                    UPDATE points[m
[31m-                    SET points = %s, updated_at = CURRENT_TIMESTAMP[m
[31m-                    WHERE user_id = %s[m
[31m-                """, (new_points, user_id))[m
[31m-            else:[m
[31m-                cursor.execute("""[m
[31m-                    UPDATE points[m
[31m-                    SET points = ?, updated_at = CURRENT_TIMESTAMP[m
[31m-                    WHERE user_id = ?[m
[31m-                """, (new_points, user_id))[m
[31m-        [m
[32m+[m[32m        cursor = conn.cursor(cursor_factory=RealDictCursor)[m
[32m+[m
[32m+[m[32m        user = ensure_user_record([m
[32m+[m[32m            cursor,[m
[32m+[m[32m            identifier,[m
[32m+[m[32m            email=data.get('user_email'),[m
[32m+[m[32m            username=data.get('username') or buyer_name or identifier.get('external_uid')[m
[32m+[m[32m        )[m
[32m+[m[32m        wallet = ensure_wallet_record(cursor, user['user_id'])[m
[32m+[m
[32m+[m[32m        metadata = {[m
[32m+[m[32m            'requested_points': float(amount_decimal),[m
[32m+[m[32m            'payment_amount': float(price_decimal),[m
[32m+[m[32m            'buyer_name': buyer_name,[m
[32m+[m[32m            'bank_info': bank_info,[m
[32m+[m[32m            'channel': data.get('channel') or 'manual',[m
[32m+[m[32m            'memo': data.get('memo') or data.get('note')[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        cursor.execute([m
[32m+[m[32m            """[m
[32m+[m[32m            INSERT INTO wallet_transactions ([m
[32m+[m[32m                wallet_id, type, amount, status, meta_json, locked, created_at, updated_at[m
[32m+[m[32m            )[m
[32m+[m[32m            VALUES (%s, 'topup', %s, 'pending', %s, FALSE, NOW(), NOW())[m
[32m+[m[32m            RETURNING transaction_id, wallet_id, status, created_at, updated_at[m
[32m+[m[32m            """,[m
[32m+[m[32m            ([m
[32m+[m[32m                wallet['wallet_id'],[m
[32m+[m[32m                amount_decimal,[m
[32m+[m[32m                json.dumps(metadata, ensure_ascii=False)[m
[32m+[m[32m            )[m
[32m+[m[32m        )[m
[32m+[m[32m        transaction = cursor.fetchone()[m
[32m+[m
         conn.commit()[m
[31m-        [m
[32m+[m
         return jsonify({[m
[31m-            'message': f'Íµ¨Îß§ Ïã†Ï≤≠Ïù¥ {status}ÎêòÏóàÏäµÎãàÎã§.',[m
[31m-            'status': status[m
[32m+[m[32m            'success': True,[m
[32m+[m[32m            'message': 'Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.',[m
[32m+[m[32m            'transaction_id': transaction['transaction_id'],[m
[32m+[m[32m            'status': transaction['status'],[m
[32m+[m[32m            'requested_points': float(amount_decimal),[m
[32m+[m[32m            'payment_amount': float(price_decimal),[m
[32m+[m[32m            'wallet_balance': decimal_to_float(wallet['balance'])[m
         }), 200[m
[31m-        [m
[32m+[m
     except Exception as e:[m
[31m-        return jsonify({'error': f'Íµ¨Îß§ Ïã†Ï≤≠ Ï≤òÎ¶¨ Ïã§Ìå®: {str(e)}'}), 500[m
[32m+[m[32m        if conn:[m
[32m+[m[32m            conn.rollback()[m
[32m+[m[32m        print(f"‚ùå Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ Ïã§Ìå®: {e}")[m
[32m+[m[32m        import traceback[m
[32m+[m[32m        traceback.print_exc()[m
[32m+[m[32m        return jsonify({'error': f'Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ ÏöîÏ≤≠ Ïã§Ìå®: {str(e)}'}), 500[m
     finally:[m
[31m-        if 'conn' in locals():[m
[32m+[m[32m        if cursor:[m
[32m+[m[32m            cursor.close()[m
[32m+[m[32m        if conn:[m
             conn.close()[m
 [m
 # Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê (Ï£ºÎ¨∏ Í≤∞Ï†úÏö©)[m
[36m@@ -4648,148 +3918,51 @@[m [mdef deduct_points():[m
             conn.close()[m
 [m
 # ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå[m
[31m-@app.route('/api/users/<path:user_id>', methods=['GET'])[m
[31m-def get_user(user_id):[m
[31m-    """ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå (ÏóÜÏúºÎ©¥ ÏûêÎèô ÏÉùÏÑ±) - Ìï≠ÏÉÅ 200 Î∞òÌôò"""[m
[31m-    import sys[m
[31m-    # user_id Ï†ïÍ∑úÌôî (ÏïûÎí§ Í≥µÎ∞± Î∞è Ïä¨ÎûòÏãú Ï†úÍ±∞)[m
[31m-    user_id = str(user_id).strip().rstrip('/')[m
[31m-    print(f"üîç ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå ÏöîÏ≤≠ - user_id: {user_id}", flush=True)[m
[31m-    sys.stdout.flush()[m
[32m+[m[32m@app.route('/api/users/<path:raw_user_id>', methods=['GET'])[m
[32m+[m[32mdef get_user(raw_user_id):[m
[32m+[m[32m    """ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå (ÏóÜÏúºÎ©¥ ÏûêÎèô ÏÉùÏÑ± ÌõÑ Î∞òÌôò)"""[m
     conn = None[m
     cursor = None[m
[32m+[m
     try:[m
[32m+[m[32m        identifier = parse_user_identifier(str(raw_user_id).rstrip('/'))[m
[32m+[m
         conn = get_db_connection()[m
[31m-        cursor = conn.cursor()[m
[31m-        print(f"‚úÖ DB Ïó∞Í≤∞ ÏÑ±Í≥µ - user_id: {user_id}", flush=True)[m
[31m-        [m
[31m-        if DATABASE_URL.startswith('postgresql://'):[m
[31m-            cursor.execute("""[m
[31m-                SELECT user_id, email, name, created_at[m
[31m-                FROM users WHERE user_id = %s[m
[31m-            """, (user_id,))[m
[31m-        else:[m
[31m-            cursor.execute("""[m
[31m-                SELECT user_id, email, name, created_at[m
[31m-                FROM users WHERE user_id = ?[m
[31m-            """, (user_id,))[m
[31m-        [m
[31m-        user = cursor.fetchone()[m
[31m-        print(f"üîç ÏÇ¨Ïö©Ïûê Ï°∞Ìöå Í≤∞Í≥º: {user}", flush=True)[m
[31m-        sys.stdout.flush()[m
[31m-        [m
[31m-        if user:[m
[31m-            user_data = {[m
[31m-                'user_id': user[0],[m
[31m-                'email': user[1],[m
[31m-                'name': user[2],[m
[31m-                'created_at': user[3].isoformat() if user[3] and hasattr(user[3], 'isoformat') else (str(user[3]) if user[3] else None)[m
[31m-            }[m
[31m-            print(f"‚úÖ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∞òÌôò: {user_data}", flush=True)[m
[31m-            sys.stdout.flush()[m
[31m-            return jsonify(user_data), 200[m
[31m-        else:[m
[31m-            # ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±[m
[31m-            print(f"‚ÑπÔ∏è ÏÇ¨Ïö©Ïûê ÏóÜÏùå, ÏûêÎèô ÏÉùÏÑ± ÏãúÎèÑ: {user_id}", flush=True)[m
[31m-            sys.stdout.flush()[m
[31m-            [m
[31m-            # emailÏù¥ NOT NULLÏù¥ÎØÄÎ°ú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Ïú†Ìö®Ìïú Ïù¥Î©îÏùº ÌòïÏãù)[m
[31m-            sanitized_user = user_id.replace('@', '_at_').replace('/', '_').replace('\\', '_')[m
[31m-            default_email = f"{sanitized_user[:200]}@temp.local"[m
[31m-            [m
[31m-            try:[m
[31m-                if DATABASE_URL.startswith('postgresql://'):[m
[31m-                    # ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± ÏãúÎèÑ[m
[31m-                    cursor.execute("""[m
[31m-                        INSERT INTO users (user_id, email, name, created_at, updated_at)[m
[31m-                        VALUES (%s, %s, %s, NOW(), NOW())[m
[31m-                        ON CONFLICT (user_id) DO NOTHING[m
[31m-                    """, (user_id, default_email, 'User'))[m
[31m-                    [m
[31m-                    # ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ïó¨Î∂Ä ÌôïÏù∏[m
[31m-                    if cursor.rowcount > 0:[m
[31m-                        # points ÌÖåÏù¥Î∏îÏóêÎèÑ Ï¥àÍ∏∞ Î†àÏΩîÎìú ÏÉùÏÑ±[m
[31m-                        cursor.execute("""[m
[31m-                            INSERT INTO points (user_id, points, created_at, updated_at)[m
[31m-                            VALUES (%s, 0, NOW(), NOW())[m
[31m-                            ON CONFLICT (user_id) DO NOTHING[m
[31m-                        """, (user_id,))[m
[31m-                        conn.commit()[m
[31m-                        print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÏûêÎèô ÏÉùÏÑ± ÏôÑÎ£å: {user_id}")[m
[31m-                    else:[m
[31m-                        # Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞, Îã§Ïãú Ï°∞Ìöå[m
[31m-                        cursor.execute("""[m
[31m-                            SELECT user_id, email, name, created_at[m
[31m-                            FROM users WHERE user_id = %s[m
[31m-                        """, (user_id,))[m
[31m-                        user = cursor.fetchone()[m
[31m-                        if user:[m
[31m-                            user_data = {[m
[31m-                                'user_id': user[0],[m
[31m-                                'email': user[1],[m
[31m-                                'name': user[2],[m
[31m-                                'created_at': user[3].isoformat() if user[3] and hasattr(user[3], 'isoformat') else (str(user[3]) if user[3] else None)[m
[31m-                            }[m
[31m-                            return jsonify(user_data), 200[m
[31m-                else:[m
[31m-                    cursor.execute("""[m
[31m-                        INSERT OR IGNORE INTO users (user_id, email, name, created_at, updated_at)[m
[31m-                        VALUES (?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)[m
[31m-                    """, (user_id, default_email, 'User'))[m
[31m-                    [m
[31m-                    cursor.execute("""[m
[31m-                        INSERT OR IGNORE INTO points (user_id, points, created_at, updated_at)[m
[31m-                        VALUES (?, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)[m
[31m-                    """, (user_id,))[m
[31m-                    conn.commit()[m
[31m-                    print(f"‚úÖ ÏÇ¨Ïö©Ïûê ÏûêÎèô ÏÉùÏÑ± ÏôÑÎ£å: {user_id}")[m
[31m-                [m
[31m-                # ÏÉùÏÑ±Îêú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∞òÌôò[m
[31m-                return jsonify({[m
[31m-                    'user_id': user_id,[m
[31m-                    'email': default_email,[m
[31m-                    'name': 'User',[m
[31m-                    'created_at': None,[m
[31m-                    'message': 'ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.'[m
[31m-                }), 200[m
[31m-                [m
[31m-            except Exception as create_error:[m
[31m-                import traceback[m
[31m-                conn.rollback()[m
[31m-                print(f"‚ö†Ô∏è ÏÇ¨Ïö©Ïûê ÏûêÎèô ÏÉùÏÑ± Ïã§Ìå®: {create_error}", file=sys.stderr, flush=True)[m
[31m-                traceback.print_exc(file=sys.stderr)[m
[31m-                sys.stderr.flush()[m
[31m-                [m
[31m-                # ÏÉùÏÑ± Ïã§Ìå®Ìï¥ÎèÑ Ìï≠ÏÉÅ 200 Î∞òÌôò (ÏÇ¨Ïö©Ïûê ÏóÜÏùå ÏÉÅÌÉú)[m
[31m-                return jsonify({[m
[31m-                    'user_id': user_id,[m
[31m-                    'email': None,[m
[31m-                    'name': None,[m
[31m-                    'created_at': None,[m
[31m-                    'message': 'ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.'[m
[31m-                }), 200[m
[31m-        [m
[32m+[m[32m        cursor = conn.cursor(cursor_factory=RealDictCursor)[m
[32m+[m
[32m+[m[32m        user = ensure_user_record(cursor, identifier)[m
[32m+[m[32m        wallet = ensure_wallet_record(cursor, user['user_id'])[m
[32m+[m
[32m+[m[32m        conn.commit()[m
[32m+[m
[32m+[m[32m        response = {[m
[32m+[m[32m            'user_id': user['user_id'],[m
[32m+[m[32m            'external_uid': user['external_uid'],[m
[32m+[m[32m            'email': user['email'],[m
[32m+[m[32m            'username': user['username'],[m
[32m+[m[32m            'referral_code': user['referral_code'],[m
[32m+[m[32m            'referral_status': user['referral_status'],[m
[32m+[m[32m            'is_admin': bool(user['is_admin']) if user.get('is_admin') is not None else False,[m
[32m+[m[32m            'created_at': to_isoformat_or_none(user['created_at']),[m
[32m+[m[32m            'updated_at': to_isoformat_or_none(user['updated_at']),[m
[32m+[m[32m            'wallet_balance': decimal_to_float(wallet['balance']) if wallet else 0.0,[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return jsonify(response), 200[m
[32m+[m
     except Exception as e:[m
[31m-        print(f"‚ùå ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ïò§Î•ò: {e}")[m
[32m+[m[32m        if conn:[m
[32m+[m[32m            conn.rollback()[m
[32m+[m[32m        print(f"‚ùå ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®: {e}")[m
         import traceback[m
         traceback.print_exc()[m
[31m-        # Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ Ìï≠ÏÉÅ 200 Î∞òÌôò (Îπà ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥)[m
[31m-        return jsonify({[m
[31m-            'user_id': user_id,[m
[31m-            'email': None,[m
[31m-            'name': None,[m
[31m-            'created_at': None,[m
[31m-            'message': f'ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù: {str(e)}'[m
[31m-        }), 200[m
[32m+[m[32m        return jsonify({'error': f'ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
     finally:[m
         if cursor:[m
             cursor.close()[m
         if conn:[m
             conn.close()[m
 [m
[31m-# Ï∂îÏ≤úÏù∏ ÏΩîÎìú ÏÉùÏÑ±[m
[31m-# ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî ÏóîÎìúÌè¨Ïù∏Ìä∏ Ï†úÍ±∞Îê® - Í¥ÄÎ¶¨Ïûê API ÏÇ¨Ïö©[m
[31m-[m
 # Ï∂îÏ≤úÏù∏ ÏΩîÎìú Ï°∞Ìöå[m
 @app.route('/api/referral/my-codes', methods=['GET'])[m
 def get_my_codes():[m
[36m@@ -5298,7 +4471,6 @@[m [mdef get_referral_commission_overview():[m
         [m
     except Exception as e:[m
         return jsonify({'error': f'Ïª§ÎØ∏ÏÖò ÌòÑÌô© Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
[31m-[m
 # Í¥ÄÎ¶¨ÏûêÏö© Ïª§ÎØ∏ÏÖò ÌôòÍ∏â Ï≤òÎ¶¨[m
 @app.route('/api/admin/referral/pay-commission', methods=['POST'])[m
 def pay_commission():[m
[36m@@ -6093,7 +5265,6 @@[m [mdef get_admin_transactions():[m
         [m
     except Exception as e:[m
         return jsonify({'error': f'Í±∞Îûò ÎÇ¥Ïó≠ Ï°∞Ìöå Ïã§Ìå®: {str(e)}'}), 500[m
[31m-[m
 # Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ ÎùºÏö∞Ìä∏[m
 @app.route('/admin')[m
 def serve_admin():[m
[36m@@ -6889,7 +6060,6 @@[m [mdef update_order_status(order_id):[m
             cursor.close()[m
         if conn:[m
             conn.close()[m
[31m-[m
 # Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨ API[m
 @app.route('/api/admin/notices', methods=['GET'])[m
 @require_admin_auth[m
[36m@@ -7656,7 +6826,6 @@[m [mdef auth_login():[m
             'success': False,[m
             'error': 'Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'[m
         }), 500[m
[31m-[m
 # Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨[m
 @app.route('/api/auth/kakao-login', methods=['POST'])[m
 def kakao_login():[m
[36m@@ -8450,7 +7619,6 @@[m [mdef serve_spa_routes():[m
     except Exception as e:[m
         print(f"‚ùå SPA ÎùºÏö∞ÌåÖ Ïò§Î•ò: {e}")[m
         return jsonify({'error': 'SPA routing failed'}), 500[m
[31m-[m
 # SPA ÎùºÏö∞ÌåÖ ÏßÄÏõê - Î™®Îì† Í≤ΩÎ°úÎ•º index.htmlÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏[m
 # Ï£ºÏùò: Ïù¥ ÎùºÏö∞Ìä∏Îäî Î™®Îì† API ÎùºÏö∞Ìä∏Î≥¥Îã§ ÎÇòÏ§ëÏóê Îì±Î°ùÎêòÏñ¥Ïïº Ìï®[m
 @app.route('/<path:path>', methods=['GET'])[m
